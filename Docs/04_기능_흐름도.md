# 4. 기능 흐름도

## 🔄 DN_SOLUTION2 기능 흐름도

### 4.1 회원가입 플로우

#### 4.1.1 전체 회원가입 흐름
```
시작: 회원가입 페이지 접속
↓
1. 회원 유형 선택
   - 본사 관리자
   - 협력사 관리자
   - 판매점 직원
↓
2. 상위 업체코드 입력 (본사 제외)
   - 본사: 상위 업체코드 입력 불필요
   - 협력사: 본사 업체코드 입력 필수
   - 판매점: 협력사 업체코드 입력 필수
↓
3. 상위 업체 정보 확인
   - 업체코드로 상위 업체 조회
   - 업체명, 타입, 상태 표시
↓
4. 업체 정보 입력
   - 업체명, 사업자등록번호, 주소, 연락처
↓
5. 관리자 정보 입력
   - 아이디, 비밀번호, 이메일, 담당자명, 연락처
↓
6. 업체코드 자동 생성
   - 협력사: "HQ20241207123456ABCD-AG20241207124500EFGH"
   - 판매점: "HQ20241207123456ABCD-AG20241207124500EFGH-RT20241207125000QRST"
↓
7. 통합 생성 처리
   - Company 테이블에 업체 정보 저장
   - CompanyUser 테이블에 관리자 정보 저장
   - 계층 관계 설정
   - 승인 대기 상태로 설정
↓
8. 업체코드 표시
   - "업체코드: HQ20241207123456ABCD-AG20241207124500EFGH"
   - "이 업체코드를 안전한 곳에 보관하세요"
↓
9. 승인 대기
   - 상태: 'pending'
   - 승인자: 상위 계층 관리자
↓
10. 승인 처리
    - 상위 계층에서 승인
    - 상태: 'approved'
    - 로그인 가능
↓
완료: 업체와 관리자가 동시에 생성되어 시스템 이용 가능
```

#### 4.1.2 본사 회원가입 상세 흐름
```
1. 회원 유형 "본사 관리자" 선택
2. 업체 정보 입력
   - 업체명: "SKT 본사"
   - 사업자등록번호: "123-45-67890"
   - 주소: "서울시 강남구..."
   - 연락처: "02-1234-5678"
3. 관리자 정보 입력
   - 아이디: "hq_admin"
   - 비밀번호: "password123"
   - 이메일: "admin@skthq.com"
   - 담당자명: "김본사"
   - 연락처: "010-1234-5678"
4. 업체코드 자동 생성: "HQ20241207123456ABCD"
5. 상태: 'approved' (본사는 자동 승인)
6. 로그인 가능
```

#### 4.1.3 협력사 회원가입 상세 흐름
```
1. 회원 유형 "협력사 관리자" 선택
2. 상위 업체코드 입력: "HQ20241207123456ABCD"
3. 상위 업체 정보 확인
   - 업체명: "SKT 본사"
   - 타입: "headquarters"
   - 상태: "active"
4. 업체 정보 입력
   - 업체명: "SKT 협력사 A"
   - 사업자등록번호: "234-56-78901"
   - 주소: "서울시 서초구..."
   - 연락처: "02-2345-6789"
5. 관리자 정보 입력
   - 아이디: "agency_admin"
   - 비밀번호: "password123"
   - 이메일: "admin@sktagency.com"
   - 담당자명: "이협력사"
   - 연락처: "010-2345-6789"
6. 업체코드 자동 생성: "HQ20241207123456ABCD-AG20241207124500EFGH"
7. 상태: 'pending'
8. 본사 승인 대기
9. 승인 후 로그인 가능
```

#### 4.1.4 판매점 회원가입 상세 흐름
```
1. 회원 유형 "판매점 직원" 선택
2. 상위 업체코드 입력: "HQ20241207123456ABCD-AG20241207124500EFGH"
3. 상위 업체 정보 확인
   - 업체명: "SKT 협력사 A"
   - 타입: "agency"
   - 상태: "active"
4. 업체 정보 입력
   - 업체명: "판매점 A-1"
   - 사업자등록번호: "345-67-89012"
   - 주소: "서울시 강남구..."
   - 연락처: "02-3456-7890"
5. 관리자 정보 입력
   - 아이디: "retail_admin"
   - 비밀번호: "password123"
   - 이메일: "admin@sktretail.com"
   - 담당자명: "박판매점"
   - 연락처: "010-3456-7890"
6. 업체코드 자동 생성: "HQ20241207123456ABCD-AG20241207124500EFGH-RT20241207125000QRST"
7. 상태: 'pending'
8. 협력사 승인 대기
9. 승인 후 로그인 가능
```

### 4.2 정책 생성 플로우

#### 4.2.1 전체 정책 생성 흐름
```
본사 관리자
↓
1단계: 업체 그룹 선택
   - 협력사 목록에서 체크박스로 선택
   - 선택된 협력사와 하위 판매점 그룹화
↓
2단계: 주문서 양식 작성
   - 미리 정의된 항목들 중에서 선택
   - 필수/선택 항목 구분
   - 드롭다운/직접입력 설정
↓
3단계: 리베이트 설정
   - SKT 요금제별 리베이트 (10K 이상: 200,000원)
   - KT 요금제별 리베이트 (10K 이상: 180,000원)
   - LGU 요금제별 리베이트 (10K 이상: 160,000원)
↓
4단계: 계약 조건 설정
   - 최소 계약 유지일: 24개월
   - 위약금: 50,000원
   - 기타 조건 설정
↓
5단계: 정책 활성화
   - 선택된 업체들에게 정책 배정
   - 주문서 양식 생성
   - 정책 활성화
```

#### 4.2.2 1단계: 업체 그룹 선택 상세
```
1. 협력사 목록 조회
   - 본사 하위의 모든 협력사 표시
   - 체크박스로 선택 가능
2. 선택된 협력사 확인
   - 협력사 A: 체크
   - 협력사 B: 체크
   - 협력사 C: 미선택
3. 하위 판매점 자동 포함
   - 협력사 A의 하위 판매점들 자동 포함
   - 협력사 B의 하위 판매점들 자동 포함
4. 그룹명 설정
   - "SKT 갤럭시 S25 프로모션 그룹"
5. 다음 단계 진행
```

#### 4.2.3 2단계: 주문서 양식 작성 상세
```
1. 미리 정의된 필드 목록 표시
   - 고객명 (text, 필수)
   - 연락처 (text, 필수)
   - 주소 (text, 선택)
   - 통신사 (select, 필수)
   - 요금제 (select, 필수)
   - 단말기 모델 (text, 선택)
   - 운송장번호 (text, 선택)
2. 필드 선택 및 설정
   - 고객명: 체크, 필수, 순서 1
   - 연락처: 체크, 필수, 순서 2
   - 주소: 체크, 선택, 순서 3
   - 통신사: 체크, 필수, 순서 4
   - 요금제: 체크, 필수, 순서 5
3. 드롭다운 옵션 설정
   - 통신사: ["SKT", "KT", "LGU"]
   - 요금제: ["5G 프리미엄 10K", "5G 프리미엄 8K"]
4. 다음 단계 진행
```

#### 4.2.4 3단계: 리베이트 설정 상세
```
1. 통신사별 리베이트 설정
   SKT:
   - 10K 이상: 200,000원
   - 8K: 160,000원
   - 6K: 120,000원
   - 4K: 80,000원
   
   KT:
   - 10K 이상: 180,000원
   - 8K: 144,000원
   - 6K: 108,000원
   - 4K: 72,000원
   
   LGU:
   - 10K 이상: 160,000원
   - 8K: 128,000원
   - 6K: 96,000원
   - 4K: 64,000원
2. 리베이트 금액 확인
3. 다음 단계 진행
```

#### 4.2.5 4단계: 계약 조건 설정 상세
```
1. 최소 계약 유지일 설정
   - 기본값: 24개월
   - 범위: 12개월 ~ 36개월
2. 위약금 설정
   - 기본값: 50,000원
   - 범위: 0원 ~ 200,000원
3. 기타 조건 설정
   - 자동 갱신 여부
   - 해지 통보 기간
   - 특별 할인 조건
4. 다음 단계 진행
```

#### 4.2.6 5단계: 정책 활성화 상세
```
1. 정책 정보 최종 확인
   - 정책명: "SKT 갤럭시 S25 프로모션"
   - 대상 업체: 협력사 A, B 및 하위 판매점들
   - 주문서 필드: 5개 필드
   - 리베이트: 통신사별 차등 적용
   - 계약 조건: 24개월, 위약금 50,000원
2. 정책 생성 및 배정
   - Policy 테이블에 정책 정보 저장
   - PolicyGroup 테이블에 그룹 정보 저장
   - PolicyGroupAssignment 테이블에 업체 배정
   - PolicyRebate 테이블에 리베이트 정보 저장
   - PolicyFormField 테이블에 주문서 필드 저장
3. 정책 활성화
   - 상태: 'active'
   - 활성화 일시 기록
4. 완료 알림
   - 선택된 업체들에게 정책 배정 완료 알림
```

### 4.3 주문 처리 플로우

#### 4.3.1 전체 주문 처리 흐름
```
판매점 직원
↓
1. 정책 선택
   - "SKT 갤럭시 S25 프로모션" 선택
↓
2. 요금제 선택
   - "5G 프리미엄 10K" 선택
   - 리베이트: 200,000원 자동 계산
↓
3. 상품 선택
   - "갤럭시 S25 256G" 선택
   - 매입가: 800,000원
   - 판매가: 900,000원
   - 마진: 100,000원
↓
4. 고객 정보 입력
   - 고객명, 연락처, 주소 등
↓
5. 최종 계산
   - 상품 마진: 100,000원
   - 리베이트: 200,000원
   - 총 수익: 300,000원
↓
6. 주문서 제출
   - 본사로 주문서 전송
   - 상태: "접수"
↓
본사 관리자
↓
7. 주문서 검토
   - 고객 정보 확인
   - 정책 조건 확인
   - 승인/반려 결정
↓
8. 상품 발송
   - 운송장번호 입력
   - 상태: "발송완료"
↓
9. 리베이트 정산
   - 상품 마진 + 리베이트 계산
   - 최종 정산 금액 계산
```

#### 4.3.2 판매점 주문 생성 상세
```
1. 정책 선택
   - 배정받은 정책 목록 표시
   - "SKT 갤럭시 S25 프로모션" 선택
   - 정책 상세 정보 확인
2. 요금제 선택
   - 선택된 정책의 요금제 목록 표시
   - "5G 프리미엄 10K" 선택
   - 월 요금: 10,000원
   - 리베이트: 200,000원 자동 계산
3. 상품 선택
   - 상품 목록에서 "갤럭시 S25 256G" 선택
   - 매입가: 800,000원
   - 판매가: 900,000원
   - 마진: 100,000원
4. 고객 정보 입력
   - 고객명: "김철수" (필수)
   - 연락처: "010-1234-5678" (필수)
   - 주소: "서울시 강남구..." (선택)
   - 통신사: "SKT" (필수)
   - 요금제: "5G 프리미엄 10K" (필수)
5. 최종 계산
   - 상품 마진: 100,000원
   - 리베이트: 200,000원
   - 총 수익: 300,000원
6. 주문서 제출
   - CustomerOrder 테이블에 주문 정보 저장
   - 상태: "pending"
   - 본사로 전송
```

#### 4.3.3 본사 주문 승인 상세
```
1. 접수된 주문 목록 확인
   - 판매점별 주문 목록 표시
   - 상태별 필터링 가능
2. 주문 상세 조회
   - 고객 정보 확인
   - 정책 조건 확인
   - 리베이트 정보 확인
   - 상품 정보 확인
3. 승인/반려 결정
   - 승인: "승인" 버튼 클릭
   - 반려: 반려 사유 입력
4. 승인 처리
   - 주문 상태: "pending" → "approved"
   - 승인자 정보 기록
   - 승인 일시 기록
5. 운송장번호 입력
   - 운송장번호: "1234567890"
   - 배송업체: "CJ대한통운"
6. 발송 완료
   - 주문 상태: "approved" → "shipped"
   - 발송 일시 기록
   - 판매점에 알림 발송
```

#### 4.3.4 리베이트 정산 처리 상세
```
1. 주문 완료 시 자동 정산
   - 주문 상태가 "shipped"로 변경될 때
   - RebateSettlement 테이블에 정산 정보 저장
2. 정산 정보 계산
   - 리베이트 금액: 200,000원
   - 상품 마진: 100,000원
   - 총 수익: 300,000원
3. 정산 처리
   - 판매점 리베이트 잔액 차감
   - 정산 상태: "completed"
   - 정산 일시 기록
4. 정산 완료 알림
   - 판매점에 정산 완료 알림
   - 협력사에 정산 정보 전달
```

### 4.4 리베이트 할당 플로우

#### 4.4.1 전체 리베이트 할당 흐름
```
본사 (HQ)
↓
1. 협력사에 총 리베이트 할당
   - 협력사 A: 500,000원
   - 협력사 B: 300,000원
↓
협력사 (Agency)
↓
2. 할당받은 금액을 판매점에 분배
   - 판매점 A-1: 200,000원
   - 판매점 A-2: 150,000원
   - 협력사 A 잔액: 150,000원
↓
판매점 (Retailer)
↓
3. 주문 시 리베이트 사용
   - 주문 1: 50,000원 사용
   - 주문 2: 30,000원 사용
   - 잔액: 120,000원
```

#### 4.4.2 본사 리베이트 할당 상세
```
1. 할당 기간 설정
   - 시작일: 2024-08-01
   - 종료일: 2024-08-31
   - 기간: 31일
2. 협력사 선택
   - 협력사 A: 체크
   - 협력사 B: 체크
   - 협력사 C: 미선택
3. 할당 금액 입력
   - 협력사 A: 5,000,000원
   - 협력사 B: 3,000,000원
   - 총 할당 금액: 8,000,000원
4. 할당 처리
   - RebateAllocation 테이블에 할당 정보 저장
   - 협력사 잔액 업데이트
   - 할당 상태: "approved"
5. 할당 완료 알림
   - 협력사에게 할당 완료 알림
   - 할당 금액 및 기간 정보 전달
```

#### 4.4.3 협력사 리베이트 분배 상세
```
1. 할당받은 리베이트 확인
   - 할당 금액: 5,000,000원
   - 사용 가능 금액: 5,000,000원
   - 할당 기간: 2024-08-01 ~ 2024-08-31
2. 하위 판매점 선택
   - 판매점 A-1: 체크
   - 판매점 A-2: 체크
   - 판매점 A-3: 체크
3. 분배 금액 입력
   - 판매점 A-1: 2,000,000원
   - 판매점 A-2: 1,500,000원
   - 판매점 A-3: 1,000,000원
   - 총 분배 금액: 4,500,000원
   - 잔여 금액: 500,000원
4. 분배 처리
   - RebateAllocation 테이블에 분배 정보 저장
   - 판매점 잔액 업데이트
   - 분배 상태: "approved"
5. 분배 완료 알림
   - 판매점에게 분배 완료 알림
   - 분배 금액 및 기간 정보 전달
```

#### 4.4.4 판매점 리베이트 사용 상세
```
1. 리베이트 잔액 확인
   - 할당 금액: 2,000,000원
   - 사용 금액: 0원
   - 잔액: 2,000,000원
2. 주문 생성 시 리베이트 적용
   - 주문 1: 50,000원 사용
   - 잔액: 1,950,000원
   - 주문 2: 30,000원 사용
   - 잔액: 1,920,000원
3. 리베이트 차감 처리
   - 주문 시 자동으로 리베이트 차감
   - 잔액 부족 시 주문 불가
   - 리베이트 사용 내역 기록
4. 정산 처리
   - 주문 완료 시 자동 정산
   - 리베이트 + 상품 마진 = 총 수익
```

### 4.5 정산 승인 플로우

#### 4.5.1 전체 정산 승인 흐름
```
본사 관리자
↓
1. 정산 승인 페이지 접속
↓
2. 정산 기간 선택
   - 시작일: 2024-08-01
   - 종료일: 2024-08-31
   - 기간: 31일
↓
3. 정산 대상 조회
   - 총 주문: 150건
   - 총 리베이트 사용: 12,500,000원
   - 총 상품 마진: 7,500,000원
   - 총 정산 금액: 20,000,000원
↓
4. 정산 내역 확인
   ├── 협력사1: 5,000,000원 (50건)
   ├── 협력사2: 4,000,000원 (40건)
   ├── 협력사3: 3,500,000원 (35건)
   └── 협력사4: 3,000,000원 (25건)
↓
5. 전체 선택 → 정산 승인
   - 정산 상태: 'pending' → 'approved'
   - 정산 일시 기록
   - 정산 완료 알림 발송
↓
완료: 선택된 기간의 정산이 승인되어 최종 처리됨
```

#### 4.5.2 정산 기간 선택 상세
```
1. 정산 기간 설정
   - 시작일: 2024-08-01
   - 종료일: 2024-08-31
   - 기간: 31일
2. 정산 대상 조회
   - 해당 기간의 모든 주문 조회
   - 완료된 주문만 대상으로 함
   - 진행 중인 주문은 제외
3. 정산 정보 계산
   - 총 주문 수: 150건
   - 총 리베이트 사용: 12,500,000원
   - 총 상품 마진: 7,500,000원
   - 총 정산 금액: 20,000,000원
```

#### 4.5.3 정산 내역 확인 상세
```
1. 협력사별 정산 내역
   협력사1:
   - 주문 수: 50건
   - 리베이트 사용: 4,000,000원
   - 상품 마진: 1,000,000원
   - 총 정산: 5,000,000원
   
   협력사2:
   - 주문 수: 40건
   - 리베이트 사용: 3,200,000원
   - 상품 마진: 800,000원
   - 총 정산: 4,000,000원
   
   협력사3:
   - 주문 수: 35건
   - 리베이트 사용: 2,800,000원
   - 상품 마진: 700,000원
   - 총 정산: 3,500,000원
   
   협력사4:
   - 주문 수: 25건
   - 리베이트 사용: 2,500,000원
   - 상품 마진: 500,000원
   - 총 정산: 3,000,000원
2. 상세 내역 확인
   - 각 협력사별 판매점 정산 내역
   - 주문별 상세 정보
   - 리베이트 사용 내역
```

#### 4.5.4 정산 승인 처리 상세
```
1. 전체 선택
   - 모든 협력사 정산 내역 선택
   - 개별 선택도 가능
2. 정산 승인
   - "정산 승인" 버튼 클릭
   - 승인 확인 다이얼로그 표시
3. 승인 처리
   - SettlementApproval 테이블에 승인 정보 저장
   - 정산 상태: 'pending' → 'approved'
   - 승인자 정보 기록
   - 승인 일시 기록
4. 정산 완료 알림
   - 모든 협력사에게 정산 승인 완료 알림
   - 정산 금액 및 기간 정보 전달
5. 엑셀 다운로드
   - 정산 상세 내역 엑셀 파일 생성
   - 계층별 정산 내역 엑셀 파일 생성
```

### 4.6 엑셀 다운로드 플로우

#### 4.6.1 정산 상세 내역 다운로드
```
1. 엑셀 다운로드 페이지 접속
2. 기간 선택
   - 시작일: 2024-08-01
   - 종료일: 2024-08-31
3. 다운로드 옵션 선택
   - 정산 상세 내역
   - 계층별 정산 내역
   - 주문 내역
   - 리베이트 내역
4. 엑셀 파일 생성
   - Pandas를 사용한 데이터 처리
   - Openpyxl을 사용한 엑셀 파일 생성
   - 스타일링 적용
5. 파일 다운로드
   - 파일명: "정산내역_20241207_143022.xlsx"
   - 다운로드 완료
```

#### 4.6.2 계층별 정산 내역 다운로드 (본사용)
```
1. 본사 관리자 권한 확인
2. 계층별 정산 데이터 조회
   본사
   ├── 협력사1
   │   ├── 판매점1-1: 1,000,000원
   │   ├── 판매점1-2: 800,000원
   │   └── 판매점1-3: 600,000원
   ├── 협력사2
   │   ├── 판매점2-1: 900,000원
   │   └── 판매점2-2: 700,000원
   └── 협력사3
       ├── 판매점3-1: 500,000원
       └── 판매점3-2: 400,000원
3. 엑셀 파일 생성
   - 계층 구조를 반영한 엑셀 시트 구성
   - 각 계층별 합계 계산
   - 전체 합계 계산
4. 파일 다운로드
   - 파일명: "계층별정산내역_20241207_143022.xlsx"
   - 다운로드 완료
```

### 4.7 실시간 업데이트 플로우

#### 4.7.1 자동 새로고침
```
1. 대시보드 데이터 자동 업데이트
   - 30초 간격으로 자동 새로고침
   - 사용자 설정 가능 (10초 ~ 60초)
2. 업데이트 대상 데이터
   - 주문 현황
   - 리베이트 잔액
   - 정산 정보
   - 통계 데이터
3. 변경사항 표시
   - 새로운 주문 알림
   - 리베이트 할당 알림
   - 정산 승인 알림
4. 실시간 반영
   - 페이지 새로고침 없이 데이터 업데이트
   - 사용자 경험 향상
```

#### 4.7.2 WebSocket 실시간 업데이트 (고급 기능)
```
1. WebSocket 연결
   - 클라이언트와 서버 간 실시간 연결
   - 양방향 통신 지원
2. 실시간 이벤트 처리
   - 새로운 주문 생성 시 알림
   - 주문 상태 변경 시 알림
   - 리베이트 할당 시 알림
   - 정산 승인 시 알림
3. 실시간 데이터 동기화
   - 대시보드 데이터 실시간 업데이트
   - 주문 목록 실시간 업데이트
   - 정산 정보 실시간 업데이트
4. 연결 관리
   - 연결 끊김 시 자동 재연결
   - 연결 상태 모니터링
   - 에러 처리
```

이 기능 흐름도는 시스템의 핵심 비즈니스 로직을 단계별로 상세하게 설명합니다.
