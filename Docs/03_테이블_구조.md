# 3. í…Œì´ë¸” êµ¬ì¡°

## ğŸ—„ï¸ DN_SOLUTION2 í…Œì´ë¸” êµ¬ì¡°

### 3.1 í•µì‹¬ í…Œì´ë¸” ëª©ë¡
```
1. companies - ì—…ì²´ ì •ë³´
2. company_users - ì—…ì²´ ì‚¬ìš©ì
3. telecom_providers - í†µì‹ ì‚¬
4. plans - ìš”ê¸ˆì œ
5. policies - ì •ì±…
6. policy_groups - ì •ì±… ê·¸ë£¹
7. policy_group_assignments - ì •ì±… ê·¸ë£¹ ë°°ì •
8. policy_rebates - ì •ì±…ë³„ ë¦¬ë² ì´íŠ¸
9. product_prices - ìƒí’ˆ ê°€ê²©
10. order_form_fields - ì£¼ë¬¸ì„œ í•„ë“œ
11. policy_form_fields - ì •ì±…ë³„ ì£¼ë¬¸ì„œ í•„ë“œ
12. customer_orders - ê³ ê° ì£¼ë¬¸
13. order_status_logs - ì£¼ë¬¸ ìƒíƒœ ë¡œê·¸
14. order_attachments - ì£¼ë¬¸ ì²¨ë¶€íŒŒì¼
15. rebate_allocations - ë¦¬ë² ì´íŠ¸ í• ë‹¹
16. rebate_settlements - ë¦¬ë² ì´íŠ¸ ì •ì‚°
17. settlement_approvals - ì •ì‚° ìŠ¹ì¸
18. settlement_summaries - ì •ì‚° ìš”ì•½
```

### 3.2 ìƒì„¸ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

#### 3.2.1 Company (ì—…ì²´) í…Œì´ë¸”
```sql
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(100) UNIQUE NOT NULL, -- ì—…ì²´ì½”ë“œ (ìë™ìƒì„±)
    name VARCHAR(200) NOT NULL, -- ì—…ì²´ëª…
    type ENUM('headquarters', 'agency', 'retail') NOT NULL, -- ì—…ì²´ íƒ€ì…
    parent_company_id UUID REFERENCES companies(id), -- ìƒìœ„ ì—…ì²´ ID
    business_number VARCHAR(20), -- ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸
    address TEXT, -- ì£¼ì†Œ
    contact_number VARCHAR(20), -- ì—°ë½ì²˜
    status BOOLEAN DEFAULT TRUE, -- ìš´ì˜ ìƒíƒœ
    rebate_balance DECIMAL(15,2) DEFAULT 0, -- ë¦¬ë² ì´íŠ¸ ì”ì•¡
    created_by UUID REFERENCES company_users(id), -- ìƒì„±ì
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_companies_type ON companies(type);
CREATE INDEX idx_companies_parent ON companies(parent_company_id);
CREATE INDEX idx_companies_code ON companies(code);
```

#### 3.2.2 CompanyUser (ì—…ì²´ ì‚¬ìš©ì) í…Œì´ë¸”
```sql
CREATE TABLE company_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    django_user_id INTEGER NOT NULL REFERENCES auth_user(id),
    username VARCHAR(150) NOT NULL, -- ì‚¬ìš©ìëª…
    role ENUM('admin', 'staff') NOT NULL DEFAULT 'staff', -- ì—­í• 
    status ENUM('pending', 'approved', 'rejected') NOT NULL DEFAULT 'pending', -- ìŠ¹ì¸ ìƒíƒœ
    is_approved BOOLEAN DEFAULT FALSE, -- ìŠ¹ì¸ ì—¬ë¶€
    approved_by UUID REFERENCES company_users(id), -- ìŠ¹ì¸ì
    approved_at TIMESTAMP, -- ìŠ¹ì¸ ì¼ì‹œ
    is_primary_admin BOOLEAN DEFAULT FALSE, -- ìµœì´ˆ ê´€ë¦¬ì ì—¬ë¶€
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_company_users_company ON company_users(company_id);
CREATE INDEX idx_company_users_status ON company_users(status);
CREATE INDEX idx_company_users_role ON company_users(role);
```

#### 3.2.3 TelecomProvider (í†µì‹ ì‚¬) í…Œì´ë¸”
```sql
CREATE TABLE telecom_providers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL UNIQUE, -- í†µì‹ ì‚¬ëª… (SKT, KT, LGU)
    code VARCHAR(10) NOT NULL UNIQUE, -- í†µì‹ ì‚¬ ì½”ë“œ
    is_active BOOLEAN DEFAULT TRUE, -- í™œì„±í™” ìƒíƒœ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì´ˆê¸° ë°ì´í„°
INSERT INTO telecom_providers (name, code) VALUES
('SKT', 'SKT'),
('KT', 'KT'),
('LGU', 'LGU');
```

#### 3.2.4 Plan (ìš”ê¸ˆì œ) í…Œì´ë¸”
```sql
CREATE TABLE plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telecom_provider_id UUID NOT NULL REFERENCES telecom_providers(id),
    name VARCHAR(200) NOT NULL, -- ìš”ê¸ˆì œëª… (ì˜ˆ: 5G í”„ë¦¬ë¯¸ì—„ 10K)
    monthly_fee INTEGER NOT NULL, -- ì›” ìš”ê¸ˆ (ì˜ˆ: 10000)
    category VARCHAR(20) NOT NULL, -- ìš”ê¸ˆì œ ì¹´í…Œê³ ë¦¬ (10K ì´ìƒ, 8K, 6K, 4K)
    is_active BOOLEAN DEFAULT TRUE, -- í™œì„±í™” ìƒíƒœ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_plans_provider ON plans(telecom_provider_id);
CREATE INDEX idx_plans_category ON plans(category);
CREATE INDEX idx_plans_active ON plans(is_active);
```

#### 3.2.5 Policy (ì •ì±…) í…Œì´ë¸”
```sql
CREATE TABLE policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL, -- ì •ì±…ëª…
    description TEXT, -- ì •ì±… ì„¤ëª…
    type ENUM('individual', 'business') NOT NULL, -- ì •ì±… ìœ í˜•
    min_contract_days INTEGER DEFAULT 24, -- ìµœì†Œ ê³„ì•½ ìœ ì§€ì¼
    penalty_amount DECIMAL(15,2) DEFAULT 50000, -- ìœ„ì•½ê¸ˆ
    is_active BOOLEAN DEFAULT TRUE, -- í™œì„±í™” ìƒíƒœ
    created_by UUID NOT NULL REFERENCES company_users(id), -- ìƒì„±ì
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_policies_created_by ON policies(created_by);
CREATE INDEX idx_policies_active ON policies(is_active);
CREATE INDEX idx_policies_type ON policies(type);
```

#### 3.2.6 PolicyGroup (ì •ì±… ê·¸ë£¹) í…Œì´ë¸”
```sql
CREATE TABLE policy_groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES policies(id),
    group_name VARCHAR(200) NOT NULL, -- ê·¸ë£¹ëª… (ì˜ˆ: "SKT í˜‘ë ¥ì‚¬ A ê·¸ë£¹")
    description TEXT, -- ê·¸ë£¹ ì„¤ëª…
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_policy_groups_policy ON policy_groups(policy_id);
```

#### 3.2.7 PolicyGroupAssignment (ì •ì±… ê·¸ë£¹ ë°°ì •) í…Œì´ë¸”
```sql
CREATE TABLE policy_group_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_group_id UUID NOT NULL REFERENCES policy_groups(id),
    company_id UUID NOT NULL REFERENCES companies(id), -- ë°°ì •ëœ ì—…ì²´
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- ë°°ì • ì‹œê°
    assigned_by UUID NOT NULL REFERENCES company_users(id), -- ë°°ì •ì
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_policy_group_assignments_group ON policy_group_assignments(policy_group_id);
CREATE INDEX idx_policy_group_assignments_company ON policy_group_assignments(company_id);
```

#### 3.2.8 PolicyRebate (ì •ì±…ë³„ ë¦¬ë² ì´íŠ¸) í…Œì´ë¸”
```sql
CREATE TABLE policy_rebates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES policies(id),
    telecom_provider_id UUID NOT NULL REFERENCES telecom_providers(id),
    plan_category VARCHAR(20) NOT NULL, -- ìš”ê¸ˆì œ ì¹´í…Œê³ ë¦¬ (10K ì´ìƒ, 8K, 6K, 4K)
    rebate_amount DECIMAL(15,2) NOT NULL, -- ë¦¬ë² ì´íŠ¸ ê¸ˆì•¡
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_policy_rebates_policy ON policy_rebates(policy_id);
CREATE INDEX idx_policy_rebates_provider ON policy_rebates(telecom_provider_id);
CREATE INDEX idx_policy_rebates_category ON policy_rebates(plan_category);
```

#### 3.2.9 ProductPrice (ìƒí’ˆ ê°€ê²©) í…Œì´ë¸”
```sql
CREATE TABLE product_prices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- ì—…ì²´ ID
    product_name VARCHAR(200) NOT NULL, -- ìƒí’ˆëª… (ì˜ˆ: ê°¤ëŸ­ì‹œ S25 256G)
    product_category VARCHAR(50) NOT NULL, -- ìƒí’ˆ ì¹´í…Œê³ ë¦¬ (ë‹¨ë§ê¸°, ì•¡ì„¸ì„œë¦¬, ê¸°íƒ€)
    purchase_price DECIMAL(15,2) NOT NULL, -- ë§¤ì…ê°€
    selling_price DECIMAL(15,2) NOT NULL, -- íŒë§¤ê°€
    profit_margin DECIMAL(15,2) NOT NULL, -- ë§ˆì§„
    is_active BOOLEAN DEFAULT TRUE, -- í™œì„±í™” ìƒíƒœ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_product_prices_company ON product_prices(company_id);
CREATE INDEX idx_product_prices_category ON product_prices(product_category);
CREATE INDEX idx_product_prices_active ON product_prices(is_active);
```

#### 3.2.10 OrderFormField (ì£¼ë¬¸ì„œ í•„ë“œ) í…Œì´ë¸”
```sql
CREATE TABLE order_form_fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    field_name VARCHAR(100) NOT NULL UNIQUE, -- í•„ë“œëª… (ì˜ˆ: customer_name, phone_number)
    display_name VARCHAR(200) NOT NULL, -- í™”ë©´ í‘œì‹œëª… (ì˜ˆ: ê³ ê°ëª…, ì—°ë½ì²˜)
    field_type ENUM('text', 'select', 'date', 'checkbox', 'radio', 'file') NOT NULL, -- í•„ë“œ íƒ€ì…
    is_required BOOLEAN DEFAULT FALSE, -- í•„ìˆ˜ ì—¬ë¶€
    default_value VARCHAR(500), -- ê¸°ë³¸ê°’
    options JSON, -- ë“œë¡­ë‹¤ìš´ ì˜µì…˜ë“¤ (ì˜ˆ: ["SKT", "KT", "LGU"])
    validation_rules JSON, -- ìœ íš¨ì„± ê²€ì‚¬ ê·œì¹™
    order_index INTEGER NOT NULL, -- í‘œì‹œ ìˆœì„œ
    is_active BOOLEAN DEFAULT TRUE, -- í™œì„±í™” ìƒíƒœ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_order_form_fields_active ON order_form_fields(is_active);
CREATE INDEX idx_order_form_fields_order ON order_form_fields(order_index);
```

#### 3.2.11 PolicyFormField (ì •ì±…ë³„ ì£¼ë¬¸ì„œ í•„ë“œ) í…Œì´ë¸”
```sql
CREATE TABLE policy_form_fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES policies(id),
    field_id UUID NOT NULL REFERENCES order_form_fields(id),
    is_required BOOLEAN DEFAULT FALSE, -- í•´ë‹¹ ì •ì±…ì—ì„œ í•„ìˆ˜ ì—¬ë¶€
    order_index INTEGER NOT NULL, -- ì •ì±… ë‚´ í‘œì‹œ ìˆœì„œ
    default_value VARCHAR(500), -- ì •ì±…ë³„ ê¸°ë³¸ê°’
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_policy_form_fields_policy ON policy_form_fields(policy_id);
CREATE INDEX idx_policy_form_fields_field ON policy_form_fields(field_id);
CREATE INDEX idx_policy_form_fields_order ON policy_form_fields(order_index);
```

#### 3.2.12 CustomerOrder (ê³ ê° ì£¼ë¬¸) í…Œì´ë¸”
```sql
CREATE TABLE customer_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- ì£¼ë¬¸ ì—…ì²´
    policy_id UUID REFERENCES policies(id), -- ì„ íƒëœ ì •ì±…
    customer_group VARCHAR(50), -- ê³ ê° ê·¸ë£¹
    store VARCHAR(100), -- íŒë§¤ì 
    status VARCHAR(50) DEFAULT 'pending', -- ì§„í–‰ ìƒíƒœ
    activation_status VARCHAR(50), -- ê°œí†µ ìƒíƒœ
    customer_name VARCHAR(100) NOT NULL, -- ê³ ê°ëª…
    customer_type VARCHAR(50), -- ê³ ê°ìœ í˜•
    registration_number VARCHAR(20), -- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸
    customer_address TEXT, -- ê³ ê° ì£¼ì†Œ
    customer_email VARCHAR(100), -- ê³ ê° ì´ë©”ì¼
    customer_phone VARCHAR(20), -- ê³ ê° ì—°ë½ì²˜
    alt_contact VARCHAR(20), -- ë¹„ìƒì—°ë½ì²˜
    recipient_name VARCHAR(100), -- ìˆ˜ë ¹ì¸
    shipping_address TEXT, -- ìˆ˜ë ¹ ì£¼ì†Œ
    shipping_type VARCHAR(30), -- ë°°ì†¡ ìœ í˜•
    is_same_address BOOLEAN DEFAULT FALSE, -- ê³ ê° ì£¼ì†Œ ë™ì¼ ì—¬ë¶€
    application_code VARCHAR(50), -- ì‹ ì²­ì½”ë“œ
    device_color VARCHAR(50), -- ë‹¨ë§ê¸° ìƒ‰ìƒ
    device_model VARCHAR(100), -- ëª¨ë¸ë²ˆí˜¸
    device_model_type VARCHAR(100), -- ìœ ì‹¬ ëª¨ë¸
    device_serial VARCHAR(100), -- ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸
    selected_plan_id UUID REFERENCES plans(id), -- ì„ íƒëœ ìš”ê¸ˆì œ ID
    plan_monthly_fee INTEGER, -- ìš”ê¸ˆì œ ì›” ìš”ê¸ˆ
    plan_category VARCHAR(20), -- ìš”ê¸ˆì œ ì¹´í…Œê³ ë¦¬
    rebate_amount DECIMAL(15,2) DEFAULT 0, -- í•´ë‹¹ ìš”ê¸ˆì œ ë¦¬ë² ì´íŠ¸ ê¸ˆì•¡
    product_price_id UUID REFERENCES product_prices(id), -- ì„ íƒëœ ìƒí’ˆ ê°€ê²© ID
    product_purchase_price DECIMAL(15,2), -- ìƒí’ˆ ë§¤ì…ê°€
    product_selling_price DECIMAL(15,2), -- ìƒí’ˆ íŒë§¤ê°€
    product_profit DECIMAL(15,2), -- ìƒí’ˆ ë§ˆì§„
    telecom_provider VARCHAR(50), -- ê°€ì…í†µì‹ ì‚¬
    subscriber_type VARCHAR(50), -- ìœ ì‹¬ê°€ì…êµ¬ë¶„
    sales_person VARCHAR(100), -- íŒë§¤ìëª…
    benefit_code VARCHAR(50), -- í˜œíƒì½”ë“œ
    usage_fee DECIMAL(15,2), -- ì‹¤ì‚¬ìš©ì•¡
    payment_method VARCHAR(30), -- ë‚©ë¶€ ë°©ë²•
    payment_issuer VARCHAR(50), -- ì€í–‰ ë˜ëŠ” ì¹´ë“œì‚¬
    account_or_card_number VARCHAR(50), -- ê³„ì¢Œ(ì¹´ë“œ) ë²ˆí˜¸
    card_expiry DATE, -- ì¹´ë“œ ìœ íš¨ê¸°ê°„
    depositor_name VARCHAR(100), -- ì˜ˆê¸ˆì£¼ëª…
    depositor_birth DATE, -- ì˜ˆê¸ˆì£¼ ìƒë…„ì›”ì¼
    is_same_as_customer BOOLEAN DEFAULT FALSE, -- ê³ ê°ëª…ê³¼ ë™ì¼ ì—¬ë¶€
    tracking_number VARCHAR(100), -- ìš´ì†¡ì¥ë²ˆí˜¸
    recent_note TEXT, -- ìµœê·¼ ë©”ëª¨
    status_manager_id UUID REFERENCES company_users(id), -- ì§„í–‰ ìƒíƒœ ë‹´ë‹¹ì
    activation_manager_id UUID REFERENCES company_users(id), -- ê°œí†µ ìƒíƒœ ë‹´ë‹¹ì
    final_rebate_amount DECIMAL(15,2) DEFAULT 0, -- ìµœì¢… ë¦¬ë² ì´íŠ¸ ê¸ˆì•¡
    created_by UUID NOT NULL REFERENCES company_users(id), -- ìƒì„±ì
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_customer_orders_company ON customer_orders(company_id);
CREATE INDEX idx_customer_orders_policy ON customer_orders(policy_id);
CREATE INDEX idx_customer_orders_status ON customer_orders(status);
CREATE INDEX idx_customer_orders_created_at ON customer_orders(created_at);
CREATE INDEX idx_customer_orders_customer_name ON customer_orders(customer_name);
```

#### 3.2.13 OrderStatusLog (ì£¼ë¬¸ ìƒíƒœ ë¡œê·¸) í…Œì´ë¸”
```sql
CREATE TABLE order_status_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES customer_orders(id),
    status_type ENUM('progress', 'activation', 'memo') NOT NULL, -- ìƒíƒœ íƒ€ì…
    status_value VARCHAR(100) NOT NULL, -- ìƒíƒœ ìƒì„¸
    changed_by UUID NOT NULL REFERENCES company_users(id), -- ë‹´ë‹¹ì
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- ìƒíƒœ ë³€ê²½ ì‹œê°
    memo TEXT, -- ë©”ëª¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_order_status_logs_order ON order_status_logs(order_id);
CREATE INDEX idx_order_status_logs_type ON order_status_logs(status_type);
CREATE INDEX idx_order_status_logs_changed_at ON order_status_logs(changed_at);
```

#### 3.2.14 OrderAttachment (ì£¼ë¬¸ ì²¨ë¶€íŒŒì¼) í…Œì´ë¸”
```sql
CREATE TABLE order_attachments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES customer_orders(id),
    file_slot INTEGER NOT NULL, -- íŒŒì¼ ë²ˆí˜¸ (1~4)
    file_path TEXT NOT NULL, -- íŒŒì¼ ê²½ë¡œ
    file_name VARCHAR(255) NOT NULL, -- íŒŒì¼ëª…
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- ì—…ë¡œë“œ ì‹œê°
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_order_attachments_order ON order_attachments(order_id);
CREATE INDEX idx_order_attachments_slot ON order_attachments(file_slot);
```

#### 3.2.15 RebateAllocation (ë¦¬ë² ì´íŠ¸ í• ë‹¹) í…Œì´ë¸”
```sql
CREATE TABLE rebate_allocations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    from_company_id UUID NOT NULL REFERENCES companies(id), -- í• ë‹¹í•˜ëŠ” ì—…ì²´
    to_company_id UUID NOT NULL REFERENCES companies(id), -- í• ë‹¹ë°›ëŠ” ì—…ì²´
    allocation_amount DECIMAL(15,2) NOT NULL, -- í• ë‹¹ ê¸ˆì•¡
    allocation_period_start DATE NOT NULL, -- í• ë‹¹ ê¸°ê°„ ì‹œì‘
    allocation_period_end DATE NOT NULL, -- í• ë‹¹ ê¸°ê°„ ë
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending', -- ìƒíƒœ
    allocated_by UUID NOT NULL REFERENCES company_users(id), -- í• ë‹¹ì
    allocated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- í• ë‹¹ ì‹œê°
    notes TEXT, -- ë©”ëª¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_rebate_allocations_from ON rebate_allocations(from_company_id);
CREATE INDEX idx_rebate_allocations_to ON rebate_allocations(to_company_id);
CREATE INDEX idx_rebate_allocations_status ON rebate_allocations(status);
CREATE INDEX idx_rebate_allocations_period ON rebate_allocations(allocation_period_start, allocation_period_end);
```

#### 3.2.16 RebateSettlement (ë¦¬ë² ì´íŠ¸ ì •ì‚°) í…Œì´ë¸”
```sql
CREATE TABLE rebate_settlements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES customer_orders(id),
    company_id UUID NOT NULL REFERENCES companies(id), -- ì •ì‚° ì—…ì²´
    rebate_amount DECIMAL(15,2) NOT NULL, -- ë¦¬ë² ì´íŠ¸ ê¸ˆì•¡
    product_profit DECIMAL(15,2) DEFAULT 0, -- ìƒí’ˆ ë§ˆì§„
    total_profit DECIMAL(15,2) NOT NULL, -- ì´ ìˆ˜ìµ
    settlement_type ENUM('rebate', 'product', 'total') NOT NULL, -- ì •ì‚° íƒ€ì…
    settlement_date DATE NOT NULL, -- ì •ì‚° ì¼ì
    notes TEXT, -- ë©”ëª¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_rebate_settlements_order ON rebate_settlements(order_id);
CREATE INDEX idx_rebate_settlements_company ON rebate_settlements(company_id);
CREATE INDEX idx_rebate_settlements_date ON rebate_settlements(settlement_date);
```

#### 3.2.17 SettlementApproval (ì •ì‚° ìŠ¹ì¸) í…Œì´ë¸”
```sql
CREATE TABLE settlement_approvals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- ìŠ¹ì¸í•˜ëŠ” ì—…ì²´
    settlement_period_start DATE NOT NULL, -- ì •ì‚° ê¸°ê°„ ì‹œì‘
    settlement_period_end DATE NOT NULL, -- ì •ì‚° ê¸°ê°„ ë
    total_orders INTEGER DEFAULT 0, -- ì´ ì£¼ë¬¸ ìˆ˜
    total_rebate_amount DECIMAL(15,2) DEFAULT 0, -- ì´ ë¦¬ë² ì´íŠ¸ ê¸ˆì•¡
    total_product_profit DECIMAL(15,2) DEFAULT 0, -- ì´ ìƒí’ˆ ë§ˆì§„
    total_settlement_amount DECIMAL(15,2) DEFAULT 0, -- ì´ ì •ì‚° ê¸ˆì•¡
    approval_status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending', -- ìŠ¹ì¸ ìƒíƒœ
    approved_at TIMESTAMP, -- ìŠ¹ì¸ ì‹œê°
    approved_by UUID REFERENCES company_users(id), -- ìŠ¹ì¸ì
    notes TEXT, -- ìŠ¹ì¸ ë©”ëª¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_settlement_approvals_company ON settlement_approvals(company_id);
CREATE INDEX idx_settlement_approvals_status ON settlement_approvals(approval_status);
CREATE INDEX idx_settlement_approvals_period ON settlement_approvals(settlement_period_start, settlement_period_end);
```

#### 3.2.18 SettlementSummary (ì •ì‚° ìš”ì•½) í…Œì´ë¸”
```sql
CREATE TABLE settlement_summaries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- ì—…ì²´ ID
    period_start DATE NOT NULL, -- ì •ì‚° ê¸°ê°„ ì‹œì‘
    period_end DATE NOT NULL, -- ì •ì‚° ê¸°ê°„ ë
    total_orders INTEGER DEFAULT 0, -- ì´ ì£¼ë¬¸ ìˆ˜
    total_rebate_amount DECIMAL(15,2) DEFAULT 0, -- ì´ ë¦¬ë² ì´íŠ¸
    total_product_profit DECIMAL(15,2) DEFAULT 0, -- ì´ ìƒí’ˆ ë§ˆì§„
    total_settlement_amount DECIMAL(15,2) DEFAULT 0, -- ì´ ì •ì‚° ê¸ˆì•¡
    status ENUM('pending', 'completed') DEFAULT 'pending', -- ìƒíƒœ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_settlement_summaries_company ON settlement_summaries(company_id);
CREATE INDEX idx_settlement_summaries_period ON settlement_summaries(period_start, period_end);
CREATE INDEX idx_settlement_summaries_status ON settlement_summaries(status);
```

### 3.3 í…Œì´ë¸” ê´€ê³„ë„

#### 3.3.1 í•µì‹¬ ê´€ê³„
```
companies (ì—…ì²´)
â”œâ”€â”€ company_users (ì—…ì²´ ì‚¬ìš©ì)
â”œâ”€â”€ customer_orders (ê³ ê° ì£¼ë¬¸)
â”œâ”€â”€ product_prices (ìƒí’ˆ ê°€ê²©)
â”œâ”€â”€ rebate_allocations (ë¦¬ë² ì´íŠ¸ í• ë‹¹) - from_company_id
â””â”€â”€ rebate_allocations (ë¦¬ë² ì´íŠ¸ í• ë‹¹) - to_company_id

policies (ì •ì±…)
â”œâ”€â”€ policy_groups (ì •ì±… ê·¸ë£¹)
â”œâ”€â”€ policy_rebates (ì •ì±…ë³„ ë¦¬ë² ì´íŠ¸)
â”œâ”€â”€ policy_form_fields (ì •ì±…ë³„ ì£¼ë¬¸ì„œ í•„ë“œ)
â””â”€â”€ customer_orders (ê³ ê° ì£¼ë¬¸)

telecom_providers (í†µì‹ ì‚¬)
â”œâ”€â”€ plans (ìš”ê¸ˆì œ)
â””â”€â”€ policy_rebates (ì •ì±…ë³„ ë¦¬ë² ì´íŠ¸)

plans (ìš”ê¸ˆì œ)
â””â”€â”€ customer_orders (ê³ ê° ì£¼ë¬¸)

customer_orders (ê³ ê° ì£¼ë¬¸)
â”œâ”€â”€ order_status_logs (ì£¼ë¬¸ ìƒíƒœ ë¡œê·¸)
â”œâ”€â”€ order_attachments (ì£¼ë¬¸ ì²¨ë¶€íŒŒì¼)
â””â”€â”€ rebate_settlements (ë¦¬ë² ì´íŠ¸ ì •ì‚°)
```

#### 3.3.2 ê³„ì¸µ êµ¬ì¡° ê´€ê³„
```
companies (ë³¸ì‚¬)
â””â”€â”€ companies (í˜‘ë ¥ì‚¬) - parent_company_id
    â””â”€â”€ companies (íŒë§¤ì ) - parent_company_id
        â””â”€â”€ customer_orders (ì£¼ë¬¸)
```

### 3.4 ë°ì´í„° ë¬´ê²°ì„± ì œì•½ì¡°ê±´

#### 3.4.1 ì™¸ë˜í‚¤ ì œì•½ì¡°ê±´
```sql
-- Company ê³„ì¸µ êµ¬ì¡° ì œì•½ì¡°ê±´
ALTER TABLE companies ADD CONSTRAINT fk_companies_parent 
FOREIGN KEY (parent_company_id) REFERENCES companies(id) ON DELETE CASCADE;

-- CompanyUser ì œì•½ì¡°ê±´
ALTER TABLE company_users ADD CONSTRAINT fk_company_users_company 
FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE;

-- Policy ê´€ë ¨ ì œì•½ì¡°ê±´
ALTER TABLE policy_groups ADD CONSTRAINT fk_policy_groups_policy 
FOREIGN KEY (policy_id) REFERENCES policies(id) ON DELETE CASCADE;

ALTER TABLE policy_rebates ADD CONSTRAINT fk_policy_rebates_policy 
FOREIGN KEY (policy_id) REFERENCES policies(id) ON DELETE CASCADE;

-- Order ê´€ë ¨ ì œì•½ì¡°ê±´
ALTER TABLE customer_orders ADD CONSTRAINT fk_customer_orders_company 
FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE;

ALTER TABLE order_status_logs ADD CONSTRAINT fk_order_status_logs_order 
FOREIGN KEY (order_id) REFERENCES customer_orders(id) ON DELETE CASCADE;
```

#### 3.4.2 ì²´í¬ ì œì•½ì¡°ê±´
```sql
-- ì—…ì²´ íƒ€ì… ì œì•½ì¡°ê±´
ALTER TABLE companies ADD CONSTRAINT chk_company_type 
CHECK (type IN ('headquarters', 'agency', 'retail'));

-- ì‚¬ìš©ì ì—­í•  ì œì•½ì¡°ê±´
ALTER TABLE company_users ADD CONSTRAINT chk_user_role 
CHECK (role IN ('admin', 'staff'));

-- ìƒíƒœ ì œì•½ì¡°ê±´
ALTER TABLE company_users ADD CONSTRAINT chk_user_status 
CHECK (status IN ('pending', 'approved', 'rejected'));

-- ê¸ˆì•¡ ì œì•½ì¡°ê±´
ALTER TABLE rebate_allocations ADD CONSTRAINT chk_allocation_amount 
CHECK (allocation_amount > 0);

ALTER TABLE customer_orders ADD CONSTRAINT chk_rebate_amount 
CHECK (rebate_amount >= 0);
```

### 3.5 ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤

#### 3.5.1 ë³µí•© ì¸ë±ìŠ¤
```sql
-- ê³„ì¸µ êµ¬ì¡° ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_companies_hierarchy ON companies(type, parent_company_id);

-- ì£¼ë¬¸ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_customer_orders_company_status ON customer_orders(company_id, status);

-- ì •ì‚° ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_rebate_settlements_company_date ON rebate_settlements(company_id, settlement_date);

-- ë¦¬ë² ì´íŠ¸ í• ë‹¹ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_rebate_allocations_period_status ON rebate_allocations(allocation_period_start, allocation_period_end, status);
```

#### 3.5.2 ë¶€ë¶„ ì¸ë±ìŠ¤
```sql
-- í™œì„±í™”ëœ ì •ì±…ë§Œ ì¡°íšŒ
CREATE INDEX idx_policies_active ON policies(id) WHERE is_active = TRUE;

-- ìŠ¹ì¸ëœ ì‚¬ìš©ìë§Œ ì¡°íšŒ
CREATE INDEX idx_company_users_approved ON company_users(id) WHERE is_approved = TRUE;

-- í™œì„±í™”ëœ ìš”ê¸ˆì œë§Œ ì¡°íšŒ
CREATE INDEX idx_plans_active ON plans(id) WHERE is_active = TRUE;
```

### 3.6 ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

#### 3.6.1 ì´ˆê¸° ë°ì´í„° ìƒì„±
```sql
-- í†µì‹ ì‚¬ ì´ˆê¸° ë°ì´í„°
INSERT INTO telecom_providers (name, code) VALUES
('SKT', 'SKT'),
('KT', 'KT'),
('LGU', 'LGU');

-- ìš”ê¸ˆì œ ì´ˆê¸° ë°ì´í„°
INSERT INTO plans (telecom_provider_id, name, monthly_fee, category) VALUES
((SELECT id FROM telecom_providers WHERE code = 'SKT'), '5G í”„ë¦¬ë¯¸ì—„ 10K', 10000, '10K ì´ìƒ'),
((SELECT id FROM telecom_providers WHERE code = 'SKT'), '5G í”„ë¦¬ë¯¸ì—„ 8K', 8000, '8K'),
((SELECT id FROM telecom_providers WHERE code = 'KT'), '5G í”„ë¦¬ë¯¸ì—„ 10K', 10000, '10K ì´ìƒ'),
((SELECT id FROM telecom_providers WHERE code = 'KT'), '5G í”„ë¦¬ë¯¸ì—„ 8K', 8000, '8K'),
((SELECT id FROM telecom_providers WHERE code = 'LGU'), '5G í”„ë¦¬ë¯¸ì—„ 10K', 10000, '10K ì´ìƒ'),
((SELECT id FROM telecom_providers WHERE code = 'LGU'), '5G í”„ë¦¬ë¯¸ì—„ 8K', 8000, '8K');

-- ì£¼ë¬¸ì„œ í•„ë“œ ì´ˆê¸° ë°ì´í„°
INSERT INTO order_form_fields (field_name, display_name, field_type, is_required, order_index) VALUES
('customer_name', 'ê³ ê°ëª…', 'text', TRUE, 1),
('customer_phone', 'ì—°ë½ì²˜', 'text', TRUE, 2),
('customer_address', 'ì£¼ì†Œ', 'text', FALSE, 3),
('telecom_provider', 'í†µì‹ ì‚¬', 'select', TRUE, 4),
('plan_name', 'ìš”ê¸ˆì œ', 'select', TRUE, 5),
('device_model', 'ë‹¨ë§ê¸° ëª¨ë¸', 'text', FALSE, 6),
('tracking_number', 'ìš´ì†¡ì¥ë²ˆí˜¸', 'text', FALSE, 7);
```

### 3.7 ë°ì´í„° ë°±ì—… ë° ë³µêµ¬

#### 3.7.1 ë°±ì—… ì „ëµ
```sql
-- ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
pg_dump -h localhost -U username -d dn_solution2 > backup_$(date +%Y%m%d_%H%M%S).sql

-- íŠ¹ì • í…Œì´ë¸”ë§Œ ë°±ì—…
pg_dump -h localhost -U username -d dn_solution2 -t companies -t customer_orders > orders_backup.sql

-- ìŠ¤í‚¤ë§ˆë§Œ ë°±ì—…
pg_dump -h localhost -U username -d dn_solution2 --schema-only > schema_backup.sql
```

#### 3.7.2 ë³µêµ¬ ì „ëµ
```sql
-- ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ë³µêµ¬
psql -h localhost -U username -d dn_solution2 < backup_file.sql

-- íŠ¹ì • í…Œì´ë¸” ë³µêµ¬
psql -h localhost -U username -d dn_solution2 < orders_backup.sql
```

ì´ í…Œì´ë¸” êµ¬ì¡°ëŠ” ì‹œìŠ¤í…œì˜ í•µì‹¬ ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” ì™„ì „í•œ ë°ì´í„° ëª¨ë¸ì„ ì œê³µí•©ë‹ˆë‹¤.
