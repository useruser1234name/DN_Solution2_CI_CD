# 3. 테이블 구조

## 🗄️ DN_SOLUTION2 테이블 구조

### 3.1 핵심 테이블 목록
```
1. companies - 업체 정보
2. company_users - 업체 사용자
3. telecom_providers - 통신사
4. plans - 요금제
5. policies - 정책
6. policy_groups - 정책 그룹
7. policy_group_assignments - 정책 그룹 배정
8. policy_rebates - 정책별 리베이트
9. product_prices - 상품 가격
10. order_form_fields - 주문서 필드
11. policy_form_fields - 정책별 주문서 필드
12. customer_orders - 고객 주문
13. order_status_logs - 주문 상태 로그
14. order_attachments - 주문 첨부파일
15. rebate_allocations - 리베이트 할당
16. rebate_settlements - 리베이트 정산
17. settlement_approvals - 정산 승인
18. settlement_summaries - 정산 요약
```

### 3.2 상세 테이블 스키마

#### 3.2.1 Company (업체) 테이블
```sql
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(100) UNIQUE NOT NULL, -- 업체코드 (자동생성)
    name VARCHAR(200) NOT NULL, -- 업체명
    type ENUM('headquarters', 'agency', 'retail') NOT NULL, -- 업체 타입
    parent_company_id UUID REFERENCES companies(id), -- 상위 업체 ID
    business_number VARCHAR(20), -- 사업자등록번호
    address TEXT, -- 주소
    contact_number VARCHAR(20), -- 연락처
    status BOOLEAN DEFAULT TRUE, -- 운영 상태
    rebate_balance DECIMAL(15,2) DEFAULT 0, -- 리베이트 잔액
    created_by UUID REFERENCES company_users(id), -- 생성자
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_companies_type ON companies(type);
CREATE INDEX idx_companies_parent ON companies(parent_company_id);
CREATE INDEX idx_companies_code ON companies(code);
```

#### 3.2.2 CompanyUser (업체 사용자) 테이블
```sql
CREATE TABLE company_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id),
    django_user_id INTEGER NOT NULL REFERENCES auth_user(id),
    username VARCHAR(150) NOT NULL, -- 사용자명
    role ENUM('admin', 'staff') NOT NULL DEFAULT 'staff', -- 역할
    status ENUM('pending', 'approved', 'rejected') NOT NULL DEFAULT 'pending', -- 승인 상태
    is_approved BOOLEAN DEFAULT FALSE, -- 승인 여부
    approved_by UUID REFERENCES company_users(id), -- 승인자
    approved_at TIMESTAMP, -- 승인 일시
    is_primary_admin BOOLEAN DEFAULT FALSE, -- 최초 관리자 여부
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_company_users_company ON company_users(company_id);
CREATE INDEX idx_company_users_status ON company_users(status);
CREATE INDEX idx_company_users_role ON company_users(role);
```

#### 3.2.3 TelecomProvider (통신사) 테이블
```sql
CREATE TABLE telecom_providers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL UNIQUE, -- 통신사명 (SKT, KT, LGU)
    code VARCHAR(10) NOT NULL UNIQUE, -- 통신사 코드
    is_active BOOLEAN DEFAULT TRUE, -- 활성화 상태
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 초기 데이터
INSERT INTO telecom_providers (name, code) VALUES
('SKT', 'SKT'),
('KT', 'KT'),
('LGU', 'LGU');
```

#### 3.2.4 Plan (요금제) 테이블
```sql
CREATE TABLE plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telecom_provider_id UUID NOT NULL REFERENCES telecom_providers(id),
    name VARCHAR(200) NOT NULL, -- 요금제명 (예: 5G 프리미엄 10K)
    monthly_fee INTEGER NOT NULL, -- 월 요금 (예: 10000)
    category VARCHAR(20) NOT NULL, -- 요금제 카테고리 (10K 이상, 8K, 6K, 4K)
    is_active BOOLEAN DEFAULT TRUE, -- 활성화 상태
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_plans_provider ON plans(telecom_provider_id);
CREATE INDEX idx_plans_category ON plans(category);
CREATE INDEX idx_plans_active ON plans(is_active);
```

#### 3.2.5 Policy (정책) 테이블
```sql
CREATE TABLE policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL, -- 정책명
    description TEXT, -- 정책 설명
    type ENUM('individual', 'business') NOT NULL, -- 정책 유형
    min_contract_days INTEGER DEFAULT 24, -- 최소 계약 유지일
    penalty_amount DECIMAL(15,2) DEFAULT 50000, -- 위약금
    is_active BOOLEAN DEFAULT TRUE, -- 활성화 상태
    created_by UUID NOT NULL REFERENCES company_users(id), -- 생성자
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_policies_created_by ON policies(created_by);
CREATE INDEX idx_policies_active ON policies(is_active);
CREATE INDEX idx_policies_type ON policies(type);
```

#### 3.2.6 PolicyGroup (정책 그룹) 테이블
```sql
CREATE TABLE policy_groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES policies(id),
    group_name VARCHAR(200) NOT NULL, -- 그룹명 (예: "SKT 협력사 A 그룹")
    description TEXT, -- 그룹 설명
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_policy_groups_policy ON policy_groups(policy_id);
```

#### 3.2.7 PolicyGroupAssignment (정책 그룹 배정) 테이블
```sql
CREATE TABLE policy_group_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_group_id UUID NOT NULL REFERENCES policy_groups(id),
    company_id UUID NOT NULL REFERENCES companies(id), -- 배정된 업체
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 배정 시각
    assigned_by UUID NOT NULL REFERENCES company_users(id), -- 배정자
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_policy_group_assignments_group ON policy_group_assignments(policy_group_id);
CREATE INDEX idx_policy_group_assignments_company ON policy_group_assignments(company_id);
```

#### 3.2.8 PolicyRebate (정책별 리베이트) 테이블
```sql
CREATE TABLE policy_rebates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES policies(id),
    telecom_provider_id UUID NOT NULL REFERENCES telecom_providers(id),
    plan_category VARCHAR(20) NOT NULL, -- 요금제 카테고리 (10K 이상, 8K, 6K, 4K)
    rebate_amount DECIMAL(15,2) NOT NULL, -- 리베이트 금액
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_policy_rebates_policy ON policy_rebates(policy_id);
CREATE INDEX idx_policy_rebates_provider ON policy_rebates(telecom_provider_id);
CREATE INDEX idx_policy_rebates_category ON policy_rebates(plan_category);
```

#### 3.2.9 ProductPrice (상품 가격) 테이블
```sql
CREATE TABLE product_prices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- 업체 ID
    product_name VARCHAR(200) NOT NULL, -- 상품명 (예: 갤럭시 S25 256G)
    product_category VARCHAR(50) NOT NULL, -- 상품 카테고리 (단말기, 액세서리, 기타)
    purchase_price DECIMAL(15,2) NOT NULL, -- 매입가
    selling_price DECIMAL(15,2) NOT NULL, -- 판매가
    profit_margin DECIMAL(15,2) NOT NULL, -- 마진
    is_active BOOLEAN DEFAULT TRUE, -- 활성화 상태
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_product_prices_company ON product_prices(company_id);
CREATE INDEX idx_product_prices_category ON product_prices(product_category);
CREATE INDEX idx_product_prices_active ON product_prices(is_active);
```

#### 3.2.10 OrderFormField (주문서 필드) 테이블
```sql
CREATE TABLE order_form_fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    field_name VARCHAR(100) NOT NULL UNIQUE, -- 필드명 (예: customer_name, phone_number)
    display_name VARCHAR(200) NOT NULL, -- 화면 표시명 (예: 고객명, 연락처)
    field_type ENUM('text', 'select', 'date', 'checkbox', 'radio', 'file') NOT NULL, -- 필드 타입
    is_required BOOLEAN DEFAULT FALSE, -- 필수 여부
    default_value VARCHAR(500), -- 기본값
    options JSON, -- 드롭다운 옵션들 (예: ["SKT", "KT", "LGU"])
    validation_rules JSON, -- 유효성 검사 규칙
    order_index INTEGER NOT NULL, -- 표시 순서
    is_active BOOLEAN DEFAULT TRUE, -- 활성화 상태
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_order_form_fields_active ON order_form_fields(is_active);
CREATE INDEX idx_order_form_fields_order ON order_form_fields(order_index);
```

#### 3.2.11 PolicyFormField (정책별 주문서 필드) 테이블
```sql
CREATE TABLE policy_form_fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    policy_id UUID NOT NULL REFERENCES policies(id),
    field_id UUID NOT NULL REFERENCES order_form_fields(id),
    is_required BOOLEAN DEFAULT FALSE, -- 해당 정책에서 필수 여부
    order_index INTEGER NOT NULL, -- 정책 내 표시 순서
    default_value VARCHAR(500), -- 정책별 기본값
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_policy_form_fields_policy ON policy_form_fields(policy_id);
CREATE INDEX idx_policy_form_fields_field ON policy_form_fields(field_id);
CREATE INDEX idx_policy_form_fields_order ON policy_form_fields(order_index);
```

#### 3.2.12 CustomerOrder (고객 주문) 테이블
```sql
CREATE TABLE customer_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- 주문 업체
    policy_id UUID REFERENCES policies(id), -- 선택된 정책
    customer_group VARCHAR(50), -- 고객 그룹
    store VARCHAR(100), -- 판매점
    status VARCHAR(50) DEFAULT 'pending', -- 진행 상태
    activation_status VARCHAR(50), -- 개통 상태
    customer_name VARCHAR(100) NOT NULL, -- 고객명
    customer_type VARCHAR(50), -- 고객유형
    registration_number VARCHAR(20), -- 주민등록번호
    customer_address TEXT, -- 고객 주소
    customer_email VARCHAR(100), -- 고객 이메일
    customer_phone VARCHAR(20), -- 고객 연락처
    alt_contact VARCHAR(20), -- 비상연락처
    recipient_name VARCHAR(100), -- 수령인
    shipping_address TEXT, -- 수령 주소
    shipping_type VARCHAR(30), -- 배송 유형
    is_same_address BOOLEAN DEFAULT FALSE, -- 고객 주소 동일 여부
    application_code VARCHAR(50), -- 신청코드
    device_color VARCHAR(50), -- 단말기 색상
    device_model VARCHAR(100), -- 모델번호
    device_model_type VARCHAR(100), -- 유심 모델
    device_serial VARCHAR(100), -- 유심일련번호
    selected_plan_id UUID REFERENCES plans(id), -- 선택된 요금제 ID
    plan_monthly_fee INTEGER, -- 요금제 월 요금
    plan_category VARCHAR(20), -- 요금제 카테고리
    rebate_amount DECIMAL(15,2) DEFAULT 0, -- 해당 요금제 리베이트 금액
    product_price_id UUID REFERENCES product_prices(id), -- 선택된 상품 가격 ID
    product_purchase_price DECIMAL(15,2), -- 상품 매입가
    product_selling_price DECIMAL(15,2), -- 상품 판매가
    product_profit DECIMAL(15,2), -- 상품 마진
    telecom_provider VARCHAR(50), -- 가입통신사
    subscriber_type VARCHAR(50), -- 유심가입구분
    sales_person VARCHAR(100), -- 판매자명
    benefit_code VARCHAR(50), -- 혜택코드
    usage_fee DECIMAL(15,2), -- 실사용액
    payment_method VARCHAR(30), -- 납부 방법
    payment_issuer VARCHAR(50), -- 은행 또는 카드사
    account_or_card_number VARCHAR(50), -- 계좌(카드) 번호
    card_expiry DATE, -- 카드 유효기간
    depositor_name VARCHAR(100), -- 예금주명
    depositor_birth DATE, -- 예금주 생년월일
    is_same_as_customer BOOLEAN DEFAULT FALSE, -- 고객명과 동일 여부
    tracking_number VARCHAR(100), -- 운송장번호
    recent_note TEXT, -- 최근 메모
    status_manager_id UUID REFERENCES company_users(id), -- 진행 상태 담당자
    activation_manager_id UUID REFERENCES company_users(id), -- 개통 상태 담당자
    final_rebate_amount DECIMAL(15,2) DEFAULT 0, -- 최종 리베이트 금액
    created_by UUID NOT NULL REFERENCES company_users(id), -- 생성자
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_customer_orders_company ON customer_orders(company_id);
CREATE INDEX idx_customer_orders_policy ON customer_orders(policy_id);
CREATE INDEX idx_customer_orders_status ON customer_orders(status);
CREATE INDEX idx_customer_orders_created_at ON customer_orders(created_at);
CREATE INDEX idx_customer_orders_customer_name ON customer_orders(customer_name);
```

#### 3.2.13 OrderStatusLog (주문 상태 로그) 테이블
```sql
CREATE TABLE order_status_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES customer_orders(id),
    status_type ENUM('progress', 'activation', 'memo') NOT NULL, -- 상태 타입
    status_value VARCHAR(100) NOT NULL, -- 상태 상세
    changed_by UUID NOT NULL REFERENCES company_users(id), -- 담당자
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 상태 변경 시각
    memo TEXT, -- 메모
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_order_status_logs_order ON order_status_logs(order_id);
CREATE INDEX idx_order_status_logs_type ON order_status_logs(status_type);
CREATE INDEX idx_order_status_logs_changed_at ON order_status_logs(changed_at);
```

#### 3.2.14 OrderAttachment (주문 첨부파일) 테이블
```sql
CREATE TABLE order_attachments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES customer_orders(id),
    file_slot INTEGER NOT NULL, -- 파일 번호 (1~4)
    file_path TEXT NOT NULL, -- 파일 경로
    file_name VARCHAR(255) NOT NULL, -- 파일명
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 업로드 시각
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_order_attachments_order ON order_attachments(order_id);
CREATE INDEX idx_order_attachments_slot ON order_attachments(file_slot);
```

#### 3.2.15 RebateAllocation (리베이트 할당) 테이블
```sql
CREATE TABLE rebate_allocations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    from_company_id UUID NOT NULL REFERENCES companies(id), -- 할당하는 업체
    to_company_id UUID NOT NULL REFERENCES companies(id), -- 할당받는 업체
    allocation_amount DECIMAL(15,2) NOT NULL, -- 할당 금액
    allocation_period_start DATE NOT NULL, -- 할당 기간 시작
    allocation_period_end DATE NOT NULL, -- 할당 기간 끝
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending', -- 상태
    allocated_by UUID NOT NULL REFERENCES company_users(id), -- 할당자
    allocated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 할당 시각
    notes TEXT, -- 메모
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_rebate_allocations_from ON rebate_allocations(from_company_id);
CREATE INDEX idx_rebate_allocations_to ON rebate_allocations(to_company_id);
CREATE INDEX idx_rebate_allocations_status ON rebate_allocations(status);
CREATE INDEX idx_rebate_allocations_period ON rebate_allocations(allocation_period_start, allocation_period_end);
```

#### 3.2.16 RebateSettlement (리베이트 정산) 테이블
```sql
CREATE TABLE rebate_settlements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES customer_orders(id),
    company_id UUID NOT NULL REFERENCES companies(id), -- 정산 업체
    rebate_amount DECIMAL(15,2) NOT NULL, -- 리베이트 금액
    product_profit DECIMAL(15,2) DEFAULT 0, -- 상품 마진
    total_profit DECIMAL(15,2) NOT NULL, -- 총 수익
    settlement_type ENUM('rebate', 'product', 'total') NOT NULL, -- 정산 타입
    settlement_date DATE NOT NULL, -- 정산 일자
    notes TEXT, -- 메모
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_rebate_settlements_order ON rebate_settlements(order_id);
CREATE INDEX idx_rebate_settlements_company ON rebate_settlements(company_id);
CREATE INDEX idx_rebate_settlements_date ON rebate_settlements(settlement_date);
```

#### 3.2.17 SettlementApproval (정산 승인) 테이블
```sql
CREATE TABLE settlement_approvals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- 승인하는 업체
    settlement_period_start DATE NOT NULL, -- 정산 기간 시작
    settlement_period_end DATE NOT NULL, -- 정산 기간 끝
    total_orders INTEGER DEFAULT 0, -- 총 주문 수
    total_rebate_amount DECIMAL(15,2) DEFAULT 0, -- 총 리베이트 금액
    total_product_profit DECIMAL(15,2) DEFAULT 0, -- 총 상품 마진
    total_settlement_amount DECIMAL(15,2) DEFAULT 0, -- 총 정산 금액
    approval_status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending', -- 승인 상태
    approved_at TIMESTAMP, -- 승인 시각
    approved_by UUID REFERENCES company_users(id), -- 승인자
    notes TEXT, -- 승인 메모
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_settlement_approvals_company ON settlement_approvals(company_id);
CREATE INDEX idx_settlement_approvals_status ON settlement_approvals(approval_status);
CREATE INDEX idx_settlement_approvals_period ON settlement_approvals(settlement_period_start, settlement_period_end);
```

#### 3.2.18 SettlementSummary (정산 요약) 테이블
```sql
CREATE TABLE settlement_summaries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_id UUID NOT NULL REFERENCES companies(id), -- 업체 ID
    period_start DATE NOT NULL, -- 정산 기간 시작
    period_end DATE NOT NULL, -- 정산 기간 끝
    total_orders INTEGER DEFAULT 0, -- 총 주문 수
    total_rebate_amount DECIMAL(15,2) DEFAULT 0, -- 총 리베이트
    total_product_profit DECIMAL(15,2) DEFAULT 0, -- 총 상품 마진
    total_settlement_amount DECIMAL(15,2) DEFAULT 0, -- 총 정산 금액
    status ENUM('pending', 'completed') DEFAULT 'pending', -- 상태
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_settlement_summaries_company ON settlement_summaries(company_id);
CREATE INDEX idx_settlement_summaries_period ON settlement_summaries(period_start, period_end);
CREATE INDEX idx_settlement_summaries_status ON settlement_summaries(status);
```

### 3.3 테이블 관계도

#### 3.3.1 핵심 관계
```
companies (업체)
├── company_users (업체 사용자)
├── customer_orders (고객 주문)
├── product_prices (상품 가격)
├── rebate_allocations (리베이트 할당) - from_company_id
└── rebate_allocations (리베이트 할당) - to_company_id

policies (정책)
├── policy_groups (정책 그룹)
├── policy_rebates (정책별 리베이트)
├── policy_form_fields (정책별 주문서 필드)
└── customer_orders (고객 주문)

telecom_providers (통신사)
├── plans (요금제)
└── policy_rebates (정책별 리베이트)

plans (요금제)
└── customer_orders (고객 주문)

customer_orders (고객 주문)
├── order_status_logs (주문 상태 로그)
├── order_attachments (주문 첨부파일)
└── rebate_settlements (리베이트 정산)
```

#### 3.3.2 계층 구조 관계
```
companies (본사)
└── companies (협력사) - parent_company_id
    └── companies (판매점) - parent_company_id
        └── customer_orders (주문)
```

### 3.4 데이터 무결성 제약조건

#### 3.4.1 외래키 제약조건
```sql
-- Company 계층 구조 제약조건
ALTER TABLE companies ADD CONSTRAINT fk_companies_parent 
FOREIGN KEY (parent_company_id) REFERENCES companies(id) ON DELETE CASCADE;

-- CompanyUser 제약조건
ALTER TABLE company_users ADD CONSTRAINT fk_company_users_company 
FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE;

-- Policy 관련 제약조건
ALTER TABLE policy_groups ADD CONSTRAINT fk_policy_groups_policy 
FOREIGN KEY (policy_id) REFERENCES policies(id) ON DELETE CASCADE;

ALTER TABLE policy_rebates ADD CONSTRAINT fk_policy_rebates_policy 
FOREIGN KEY (policy_id) REFERENCES policies(id) ON DELETE CASCADE;

-- Order 관련 제약조건
ALTER TABLE customer_orders ADD CONSTRAINT fk_customer_orders_company 
FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE;

ALTER TABLE order_status_logs ADD CONSTRAINT fk_order_status_logs_order 
FOREIGN KEY (order_id) REFERENCES customer_orders(id) ON DELETE CASCADE;
```

#### 3.4.2 체크 제약조건
```sql
-- 업체 타입 제약조건
ALTER TABLE companies ADD CONSTRAINT chk_company_type 
CHECK (type IN ('headquarters', 'agency', 'retail'));

-- 사용자 역할 제약조건
ALTER TABLE company_users ADD CONSTRAINT chk_user_role 
CHECK (role IN ('admin', 'staff'));

-- 상태 제약조건
ALTER TABLE company_users ADD CONSTRAINT chk_user_status 
CHECK (status IN ('pending', 'approved', 'rejected'));

-- 금액 제약조건
ALTER TABLE rebate_allocations ADD CONSTRAINT chk_allocation_amount 
CHECK (allocation_amount > 0);

ALTER TABLE customer_orders ADD CONSTRAINT chk_rebate_amount 
CHECK (rebate_amount >= 0);
```

### 3.5 성능 최적화 인덱스

#### 3.5.1 복합 인덱스
```sql
-- 계층 구조 조회 최적화
CREATE INDEX idx_companies_hierarchy ON companies(type, parent_company_id);

-- 주문 조회 최적화
CREATE INDEX idx_customer_orders_company_status ON customer_orders(company_id, status);

-- 정산 조회 최적화
CREATE INDEX idx_rebate_settlements_company_date ON rebate_settlements(company_id, settlement_date);

-- 리베이트 할당 조회 최적화
CREATE INDEX idx_rebate_allocations_period_status ON rebate_allocations(allocation_period_start, allocation_period_end, status);
```

#### 3.5.2 부분 인덱스
```sql
-- 활성화된 정책만 조회
CREATE INDEX idx_policies_active ON policies(id) WHERE is_active = TRUE;

-- 승인된 사용자만 조회
CREATE INDEX idx_company_users_approved ON company_users(id) WHERE is_approved = TRUE;

-- 활성화된 요금제만 조회
CREATE INDEX idx_plans_active ON plans(id) WHERE is_active = TRUE;
```

### 3.6 데이터 마이그레이션

#### 3.6.1 초기 데이터 생성
```sql
-- 통신사 초기 데이터
INSERT INTO telecom_providers (name, code) VALUES
('SKT', 'SKT'),
('KT', 'KT'),
('LGU', 'LGU');

-- 요금제 초기 데이터
INSERT INTO plans (telecom_provider_id, name, monthly_fee, category) VALUES
((SELECT id FROM telecom_providers WHERE code = 'SKT'), '5G 프리미엄 10K', 10000, '10K 이상'),
((SELECT id FROM telecom_providers WHERE code = 'SKT'), '5G 프리미엄 8K', 8000, '8K'),
((SELECT id FROM telecom_providers WHERE code = 'KT'), '5G 프리미엄 10K', 10000, '10K 이상'),
((SELECT id FROM telecom_providers WHERE code = 'KT'), '5G 프리미엄 8K', 8000, '8K'),
((SELECT id FROM telecom_providers WHERE code = 'LGU'), '5G 프리미엄 10K', 10000, '10K 이상'),
((SELECT id FROM telecom_providers WHERE code = 'LGU'), '5G 프리미엄 8K', 8000, '8K');

-- 주문서 필드 초기 데이터
INSERT INTO order_form_fields (field_name, display_name, field_type, is_required, order_index) VALUES
('customer_name', '고객명', 'text', TRUE, 1),
('customer_phone', '연락처', 'text', TRUE, 2),
('customer_address', '주소', 'text', FALSE, 3),
('telecom_provider', '통신사', 'select', TRUE, 4),
('plan_name', '요금제', 'select', TRUE, 5),
('device_model', '단말기 모델', 'text', FALSE, 6),
('tracking_number', '운송장번호', 'text', FALSE, 7);
```

### 3.7 데이터 백업 및 복구

#### 3.7.1 백업 전략
```sql
-- 전체 데이터베이스 백업
pg_dump -h localhost -U username -d dn_solution2 > backup_$(date +%Y%m%d_%H%M%S).sql

-- 특정 테이블만 백업
pg_dump -h localhost -U username -d dn_solution2 -t companies -t customer_orders > orders_backup.sql

-- 스키마만 백업
pg_dump -h localhost -U username -d dn_solution2 --schema-only > schema_backup.sql
```

#### 3.7.2 복구 전략
```sql
-- 전체 데이터베이스 복구
psql -h localhost -U username -d dn_solution2 < backup_file.sql

-- 특정 테이블 복구
psql -h localhost -U username -d dn_solution2 < orders_backup.sql
```

이 테이블 구조는 시스템의 핵심 기능을 지원하는 완전한 데이터 모델을 제공합니다.
