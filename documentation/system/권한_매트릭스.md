# 2. 권한 매트릭스

## 🔐 DN_SOLUTION2 권한 매트릭스

### 2.1 계층별 권한 구조

#### 2.1.1 본사 (Headquarters)
```
✅ 모든 업체 정보 조회/수정
✅ 모든 주문 정보 조회/수정
✅ 리베이트 할당/관리
✅ 정책 생성/수정/삭제
✅ 상품 가격 관리
✅ 전체 통계 조회
✅ 정산 승인
✅ 시스템 설정 관리
```

#### 2.1.2 협력사 (Agency)
```
✅ 본사 정보 조회
✅ 하위 판매점 정보 조회/수정
✅ 본사 주문 정보 조회
✅ 하위 판매점 주문 정보 조회
✅ 할당받은 리베이트 관리
✅ 하위 판매점에 리베이트 분배
✅ 상품 가격 조회
✅ 하위 판매점 정산 승인
✅ 본인 통계 조회
```

#### 2.1.3 판매점 (Retailer)
```
✅ 상위 협력사 정보 조회
✅ 본사 정보 조회
✅ 본사 주문 정보 조회
✅ 본인 주문 정보 생성/조회/수정
✅ 할당받은 리베이트 사용
✅ 상품 가격 조회
✅ 본인 정산 확인
✅ 본인 통계 조회
```

### 2.2 역할별 권한 구조

#### 2.2.1 관리자 (Admin)
```
✅ 업체 정보 관리
✅ 사용자 관리
✅ 정책 관리
✅ 주문 관리
✅ 리베이트 관리
✅ 상품 가격 관리
✅ 정산 관리
✅ 통계 조회
```

#### 2.2.2 직원 (Staff)
```
✅ 주문 생성
✅ 주문 조회
✅ 고객 정보 관리
✅ 상품 가격 조회
✅ 리베이트 잔액 확인
✅ 기본 정보 조회
```

### 2.3 권한 관리 시스템

#### 2.3.1 권한 체크 함수
```python
def check_permission(user, action, resource_type, resource_id=None):
    """
    사용자 권한 체크
    """
    company_user = user.company_user
    company = company_user.company
    
    # 본사 권한
    if company.type == 'headquarters':
        if action in ['read', 'write', 'delete'] and resource_type in ['company', 'order', 'policy', 'rebate', 'settlement']:
            return True
    
    # 협력사 권한
    elif company.type == 'agency':
        if action == 'read' and resource_type == 'company':
            # 본사 정보만 읽기 가능
            target_company = Company.objects.get(id=resource_id)
            return target_company.type == 'headquarters' or target_company.parent_company_id == company.parent_company_id
        
        elif action in ['read', 'write'] and resource_type == 'order':
            # 하위 판매점 주문만 접근 가능
            target_order = CustomerOrder.objects.get(id=resource_id)
            return target_order.company.parent_company_id == company.id
        
        elif action in ['read', 'write'] and resource_type == 'rebate':
            # 할당받은 리베이트만 관리 가능
            return resource_id == company.id
    
    # 판매점 권한
    elif company.type == 'retail':
        if action == 'read' and resource_type == 'company':
            # 상위 업체 정보만 읽기 가능
            target_company = Company.objects.get(id=resource_id)
            return target_company.id == company.parent_company_id or target_company.id == company.parent_company.parent_company_id
        
        elif action in ['read', 'write'] and resource_type == 'order':
            # 본인 주문만 접근 가능
            target_order = CustomerOrder.objects.get(id=resource_id)
            return target_order.company_id == company.id
    
    return False
```

#### 2.3.2 데이터 접근 제어
```python
def get_accessible_companies(user):
    """
    사용자가 접근 가능한 업체 목록
    """
    company_user = user.company_user
    company = company_user.company
    
    if company.type == 'headquarters':
        # 본사는 모든 업체 접근 가능
        return Company.objects.all()
    
    elif company.type == 'agency':
        # 협력사는 본사와 하위 판매점만 접근 가능
        return Company.objects.filter(
            Q(id=company.parent_company_id) |  # 본사
            Q(parent_company_id=company.id)    # 하위 판매점
        )
    
    elif company.type == 'retail':
        # 판매점은 상위 업체만 접근 가능
        return Company.objects.filter(
            Q(id=company.parent_company_id) |  # 협력사
            Q(id=company.parent_company.parent_company_id)  # 본사
        )
    
    return Company.objects.none()

def get_accessible_orders(user):
    """
    사용자가 접근 가능한 주문 목록
    """
    company_user = user.company_user
    company = company_user.company
    
    if company.type == 'headquarters':
        # 본사는 모든 하위 업체의 주문 접근 가능
        all_subordinates = get_all_subordinate_companies(company.id)
        return CustomerOrder.objects.filter(company_id__in=all_subordinates)
    
    elif company.type == 'agency':
        # 협력사는 하위 판매점의 주문만 접근 가능
        subordinate_retailers = Company.objects.filter(
            parent_company_id=company.id,
            type='retail'
        )
        return CustomerOrder.objects.filter(
            company_id__in=subordinate_retailers.values_list('id', flat=True)
        )
    
    elif company.type == 'retail':
        # 판매점은 본인 주문만 접근 가능
        return CustomerOrder.objects.filter(company_id=company.id)
    
    return CustomerOrder.objects.none()
```

### 2.4 API 권한 미들웨어

#### 2.4.1 권한 미들웨어
```python
class PermissionMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # API 요청에 대한 권한 체크
        if request.path.startswith('/api/'):
            if request.user.is_authenticated:
                # 권한 체크 로직
                if not self.check_api_permission(request):
                    return JsonResponse({
                        'error': '권한이 없습니다.'
                    }, status=403)
        
        response = self.get_response(request)
        return response

    def check_api_permission(self, request):
        """
        API 권한 체크
        """
        path = request.path
        method = request.method
        
        # 읽기 권한이 필요한 API
        if method == 'GET':
            if '/companies/' in path and not path.endswith('/my-company/'):
                return check_permission(request.user, 'read', 'company')
            elif '/orders/' in path:
                return check_permission(request.user, 'read', 'order')
            elif '/policies/' in path:
                return check_permission(request.user, 'read', 'policy')
        
        # 쓰기 권한이 필요한 API
        elif method in ['POST', 'PUT', 'PATCH']:
            if '/orders/' in path:
                return check_permission(request.user, 'write', 'order')
            elif '/policies/' in path:
                return check_permission(request.user, 'write', 'policy')
            elif '/rebates/' in path:
                return check_permission(request.user, 'write', 'rebate')
        
        # 삭제 권한이 필요한 API
        elif method == 'DELETE':
            if '/policies/' in path:
                return check_permission(request.user, 'delete', 'policy')
        
        return True
```

### 2.5 프론트엔드 권한 관리

#### 2.5.1 권한 훅
```javascript
const usePermission = () => {
    const { user } = useAuth();
    
    const hasPermission = (action, resourceType, resourceId = null) => {
        if (!user) return false;
        
        const companyType = user.company.type;
        const userRole = user.role;
        
        // 본사 권한
        if (companyType === 'headquarters') {
            return true; // 본사는 모든 권한
        }
        
        // 협력사 권한
        if (companyType === 'agency') {
            if (action === 'read' && resourceType === 'company') {
                return true; // 상위/하위 업체 정보 읽기 가능
            }
            if (action === 'write' && resourceType === 'order') {
                return true; // 하위 판매점 주문 관리 가능
            }
            if (action === 'write' && resourceType === 'rebate') {
                return true; // 할당받은 리베이트 관리 가능
            }
        }
        
        // 판매점 권한
        if (companyType === 'retail') {
            if (action === 'read' && resourceType === 'company') {
                return true; // 상위 업체 정보 읽기 가능
            }
            if (action === 'write' && resourceType === 'order') {
                return resourceId === user.company.id; // 본인 주문만
            }
        }
        
        return false;
    };
    
    return { hasPermission };
};
```

#### 2.5.2 권한 컴포넌트
```javascript
const PermissionGuard = ({ action, resourceType, resourceId, children, fallback = null }) => {
    const { hasPermission } = usePermission();
    
    if (!hasPermission(action, resourceType, resourceId)) {
        return fallback;
    }
    
    return children;
};

// 사용 예시
const OrderList = () => {
    return (
        <div>
            <h2>주문 목록</h2>
            <PermissionGuard action="read" resourceType="order">
                <OrderTable />
                <PermissionGuard action="write" resourceType="order">
                    <CreateOrderButton />
                </PermissionGuard>
            </PermissionGuard>
        </div>
    );
};
```

### 2.6 계층별 데이터 접근

#### 2.6.1 본사 데이터 접근
```python
def get_hq_accessible_data(hq_company_id):
    """
    본사가 접근 가능한 모든 데이터
    """
    # 1. 모든 하위 업체 ID 조회
    all_subordinate_ids = Company.objects.filter(
        parent_company_id__in=Company.objects.filter(
            parent_company_id=hq_company_id
        ).values_list('id', flat=True)
    ).values_list('id', flat=True)
    
    # 2. 모든 하위 업체의 주문 조회
    orders = CustomerOrder.objects.filter(
        company_id__in=all_subordinate_ids
    )
    
    # 3. 모든 하위 업체의 리베이트 정보 조회
    rebates = RebateAllocation.objects.filter(
        to_company_id__in=all_subordinate_ids
    )
    
    return {
        'orders': orders,
        'rebates': rebates,
        'hierarchy': get_company_hierarchy_for_hq(hq_company_id)
    }
```

#### 2.6.2 협력사 데이터 접근
```python
def get_agency_accessible_data(agency_company_id):
    """
    협력사가 접근 가능한 데이터
    """
    # 1. 상위 본사 정보
    parent_hq = Company.objects.get(
        id=Company.objects.get(id=agency_company_id).parent_company_id
    )
    
    # 2. 하위 판매점들
    subordinate_retailers = Company.objects.filter(
        parent_company_id=agency_company_id
    )
    
    # 3. 하위 판매점들의 주문
    orders = CustomerOrder.objects.filter(
        company_id__in=subordinate_retailers.values_list('id', flat=True)
    )
    
    return {
        'parent_hq': parent_hq,
        'subordinate_retailers': subordinate_retailers,
        'orders': orders
    }
```

#### 2.6.3 판매점 데이터 접근
```python
def get_retailer_accessible_data(retailer_company_id):
    """
    판매점이 접근 가능한 데이터
    """
    # 1. 상위 협력사 정보
    parent_agency = Company.objects.get(
        id=Company.objects.get(id=retailer_company_id).parent_company_id
    )
    
    # 2. 상위 본사 정보
    parent_hq = Company.objects.get(
        id=parent_agency.parent_company_id
    )
    
    # 3. 본인 주문들
    own_orders = CustomerOrder.objects.filter(
        company_id=retailer_company_id
    )
    
    return {
        'parent_agency': parent_agency,
        'parent_hq': parent_hq,
        'own_orders': own_orders
    }
```

### 2.7 권한 매트릭스 요약

#### 2.7.1 계층별 권한 요약
```
본사 (HQ)
├── 모든 업체 정보 조회/수정
├── 모든 주문 정보 조회/수정
├── 리베이트 할당/관리
├── 정책 생성/수정/삭제
├── 상품 가격 관리
├── 전체 통계 조회
├── 정산 승인
└── 시스템 설정 관리

협력사 (Agency)
├── 본사 정보 조회
├── 하위 판매점 정보 조회/수정
├── 본사 주문 정보 조회
├── 하위 판매점 주문 정보 조회
├── 할당받은 리베이트 관리
├── 하위 판매점에 리베이트 분배
├── 상품 가격 조회
├── 하위 판매점 정산 승인
└── 본인 통계 조회

판매점 (Retailer)
├── 상위 협력사 정보 조회
├── 본사 정보 조회
├── 본사 주문 정보 조회
├── 본인 주문 정보 생성/조회/수정
├── 할당받은 리베이트 사용
├── 상품 가격 조회
├── 본인 정산 확인
└── 본인 통계 조회
```

#### 2.7.2 역할별 권한 요약
```
관리자 (Admin)
├── 업체 정보 관리
├── 사용자 관리
├── 정책 관리
├── 주문 관리
├── 리베이트 관리
├── 상품 가격 관리
├── 정산 관리
└── 통계 조회

직원 (Staff)
├── 주문 생성
├── 주문 조회
├── 고객 정보 관리
├── 상품 가격 조회
├── 리베이트 잔액 확인
└── 기본 정보 조회
```

### 2.8 권한 관리 모범 사례

#### 2.8.1 최소 권한 원칙
```
✅ 필요한 최소한의 권한만 부여
✅ 역할 기반 접근 제어 (RBAC)
✅ 계층별 데이터 접근 제어
✅ 실시간 권한 검증
```

#### 2.8.2 보안 강화
```
✅ JWT 토큰 기반 인증
✅ 토큰 갱신 메커니즘
✅ 권한 기반 접근 제어
✅ 세션 관리
✅ HTTPS 강제
✅ SQL 인젝션 방지
✅ XSS 방지
✅ CSRF 보호
```

이 권한 매트릭스는 시스템의 보안과 데이터 무결성을 보장하는 핵심 요소입니다.
