# 2. ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤

## ğŸ” DN_SOLUTION2 ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤

### 2.1 ê³„ì¸µë³„ ê¶Œí•œ êµ¬ì¡°

#### 2.1.1 ë³¸ì‚¬ (Headquarters)
```
âœ… ëª¨ë“  ì—…ì²´ ì •ë³´ ì¡°íšŒ/ìˆ˜ì •
âœ… ëª¨ë“  ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ/ìˆ˜ì •
âœ… ë¦¬ë² ì´íŠ¸ í• ë‹¹/ê´€ë¦¬
âœ… ì •ì±… ìƒì„±/ìˆ˜ì •/ì‚­ì œ
âœ… ìƒí’ˆ ê°€ê²© ê´€ë¦¬
âœ… ì „ì²´ í†µê³„ ì¡°íšŒ
âœ… ì •ì‚° ìŠ¹ì¸
âœ… ì‹œìŠ¤í…œ ì„¤ì • ê´€ë¦¬
```

#### 2.1.2 í˜‘ë ¥ì‚¬ (Agency)
```
âœ… ë³¸ì‚¬ ì •ë³´ ì¡°íšŒ
âœ… í•˜ìœ„ íŒë§¤ì  ì •ë³´ ì¡°íšŒ/ìˆ˜ì •
âœ… ë³¸ì‚¬ ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
âœ… í•˜ìœ„ íŒë§¤ì  ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
âœ… í• ë‹¹ë°›ì€ ë¦¬ë² ì´íŠ¸ ê´€ë¦¬
âœ… í•˜ìœ„ íŒë§¤ì ì— ë¦¬ë² ì´íŠ¸ ë¶„ë°°
âœ… ìƒí’ˆ ê°€ê²© ì¡°íšŒ
âœ… í•˜ìœ„ íŒë§¤ì  ì •ì‚° ìŠ¹ì¸
âœ… ë³¸ì¸ í†µê³„ ì¡°íšŒ
```

#### 2.1.3 íŒë§¤ì  (Retailer)
```
âœ… ìƒìœ„ í˜‘ë ¥ì‚¬ ì •ë³´ ì¡°íšŒ
âœ… ë³¸ì‚¬ ì •ë³´ ì¡°íšŒ
âœ… ë³¸ì‚¬ ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
âœ… ë³¸ì¸ ì£¼ë¬¸ ì •ë³´ ìƒì„±/ì¡°íšŒ/ìˆ˜ì •
âœ… í• ë‹¹ë°›ì€ ë¦¬ë² ì´íŠ¸ ì‚¬ìš©
âœ… ìƒí’ˆ ê°€ê²© ì¡°íšŒ
âœ… ë³¸ì¸ ì •ì‚° í™•ì¸
âœ… ë³¸ì¸ í†µê³„ ì¡°íšŒ
```

### 2.2 ì—­í• ë³„ ê¶Œí•œ êµ¬ì¡°

#### 2.2.1 ê´€ë¦¬ì (Admin)
```
âœ… ì—…ì²´ ì •ë³´ ê´€ë¦¬
âœ… ì‚¬ìš©ì ê´€ë¦¬
âœ… ì •ì±… ê´€ë¦¬
âœ… ì£¼ë¬¸ ê´€ë¦¬
âœ… ë¦¬ë² ì´íŠ¸ ê´€ë¦¬
âœ… ìƒí’ˆ ê°€ê²© ê´€ë¦¬
âœ… ì •ì‚° ê´€ë¦¬
âœ… í†µê³„ ì¡°íšŒ
```

#### 2.2.2 ì§ì› (Staff)
```
âœ… ì£¼ë¬¸ ìƒì„±
âœ… ì£¼ë¬¸ ì¡°íšŒ
âœ… ê³ ê° ì •ë³´ ê´€ë¦¬
âœ… ìƒí’ˆ ê°€ê²© ì¡°íšŒ
âœ… ë¦¬ë² ì´íŠ¸ ì”ì•¡ í™•ì¸
âœ… ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
```

### 2.3 ê¶Œí•œ ê´€ë¦¬ ì‹œìŠ¤í…œ

#### 2.3.1 ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
```python
def check_permission(user, action, resource_type, resource_id=None):
    """
    ì‚¬ìš©ì ê¶Œí•œ ì²´í¬
    """
    company_user = user.company_user
    company = company_user.company
    
    # ë³¸ì‚¬ ê¶Œí•œ
    if company.type == 'headquarters':
        if action in ['read', 'write', 'delete'] and resource_type in ['company', 'order', 'policy', 'rebate', 'settlement']:
            return True
    
    # í˜‘ë ¥ì‚¬ ê¶Œí•œ
    elif company.type == 'agency':
        if action == 'read' and resource_type == 'company':
            # ë³¸ì‚¬ ì •ë³´ë§Œ ì½ê¸° ê°€ëŠ¥
            target_company = Company.objects.get(id=resource_id)
            return target_company.type == 'headquarters' or target_company.parent_company_id == company.parent_company_id
        
        elif action in ['read', 'write'] and resource_type == 'order':
            # í•˜ìœ„ íŒë§¤ì  ì£¼ë¬¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥
            target_order = CustomerOrder.objects.get(id=resource_id)
            return target_order.company.parent_company_id == company.id
        
        elif action in ['read', 'write'] and resource_type == 'rebate':
            # í• ë‹¹ë°›ì€ ë¦¬ë² ì´íŠ¸ë§Œ ê´€ë¦¬ ê°€ëŠ¥
            return resource_id == company.id
    
    # íŒë§¤ì  ê¶Œí•œ
    elif company.type == 'retail':
        if action == 'read' and resource_type == 'company':
            # ìƒìœ„ ì—…ì²´ ì •ë³´ë§Œ ì½ê¸° ê°€ëŠ¥
            target_company = Company.objects.get(id=resource_id)
            return target_company.id == company.parent_company_id or target_company.id == company.parent_company.parent_company_id
        
        elif action in ['read', 'write'] and resource_type == 'order':
            # ë³¸ì¸ ì£¼ë¬¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥
            target_order = CustomerOrder.objects.get(id=resource_id)
            return target_order.company_id == company.id
    
    return False
```

#### 2.3.2 ë°ì´í„° ì ‘ê·¼ ì œì–´
```python
def get_accessible_companies(user):
    """
    ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ì—…ì²´ ëª©ë¡
    """
    company_user = user.company_user
    company = company_user.company
    
    if company.type == 'headquarters':
        # ë³¸ì‚¬ëŠ” ëª¨ë“  ì—…ì²´ ì ‘ê·¼ ê°€ëŠ¥
        return Company.objects.all()
    
    elif company.type == 'agency':
        # í˜‘ë ¥ì‚¬ëŠ” ë³¸ì‚¬ì™€ í•˜ìœ„ íŒë§¤ì ë§Œ ì ‘ê·¼ ê°€ëŠ¥
        return Company.objects.filter(
            Q(id=company.parent_company_id) |  # ë³¸ì‚¬
            Q(parent_company_id=company.id)    # í•˜ìœ„ íŒë§¤ì 
        )
    
    elif company.type == 'retail':
        # íŒë§¤ì ì€ ìƒìœ„ ì—…ì²´ë§Œ ì ‘ê·¼ ê°€ëŠ¥
        return Company.objects.filter(
            Q(id=company.parent_company_id) |  # í˜‘ë ¥ì‚¬
            Q(id=company.parent_company.parent_company_id)  # ë³¸ì‚¬
        )
    
    return Company.objects.none()

def get_accessible_orders(user):
    """
    ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ì£¼ë¬¸ ëª©ë¡
    """
    company_user = user.company_user
    company = company_user.company
    
    if company.type == 'headquarters':
        # ë³¸ì‚¬ëŠ” ëª¨ë“  í•˜ìœ„ ì—…ì²´ì˜ ì£¼ë¬¸ ì ‘ê·¼ ê°€ëŠ¥
        all_subordinates = get_all_subordinate_companies(company.id)
        return CustomerOrder.objects.filter(company_id__in=all_subordinates)
    
    elif company.type == 'agency':
        # í˜‘ë ¥ì‚¬ëŠ” í•˜ìœ„ íŒë§¤ì ì˜ ì£¼ë¬¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥
        subordinate_retailers = Company.objects.filter(
            parent_company_id=company.id,
            type='retail'
        )
        return CustomerOrder.objects.filter(
            company_id__in=subordinate_retailers.values_list('id', flat=True)
        )
    
    elif company.type == 'retail':
        # íŒë§¤ì ì€ ë³¸ì¸ ì£¼ë¬¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥
        return CustomerOrder.objects.filter(company_id=company.id)
    
    return CustomerOrder.objects.none()
```

### 2.4 API ê¶Œí•œ ë¯¸ë“¤ì›¨ì–´

#### 2.4.1 ê¶Œí•œ ë¯¸ë“¤ì›¨ì–´
```python
class PermissionMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # API ìš”ì²­ì— ëŒ€í•œ ê¶Œí•œ ì²´í¬
        if request.path.startswith('/api/'):
            if request.user.is_authenticated:
                # ê¶Œí•œ ì²´í¬ ë¡œì§
                if not self.check_api_permission(request):
                    return JsonResponse({
                        'error': 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'
                    }, status=403)
        
        response = self.get_response(request)
        return response

    def check_api_permission(self, request):
        """
        API ê¶Œí•œ ì²´í¬
        """
        path = request.path
        method = request.method
        
        # ì½ê¸° ê¶Œí•œì´ í•„ìš”í•œ API
        if method == 'GET':
            if '/companies/' in path and not path.endswith('/my-company/'):
                return check_permission(request.user, 'read', 'company')
            elif '/orders/' in path:
                return check_permission(request.user, 'read', 'order')
            elif '/policies/' in path:
                return check_permission(request.user, 'read', 'policy')
        
        # ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•œ API
        elif method in ['POST', 'PUT', 'PATCH']:
            if '/orders/' in path:
                return check_permission(request.user, 'write', 'order')
            elif '/policies/' in path:
                return check_permission(request.user, 'write', 'policy')
            elif '/rebates/' in path:
                return check_permission(request.user, 'write', 'rebate')
        
        # ì‚­ì œ ê¶Œí•œì´ í•„ìš”í•œ API
        elif method == 'DELETE':
            if '/policies/' in path:
                return check_permission(request.user, 'delete', 'policy')
        
        return True
```

### 2.5 í”„ë¡ íŠ¸ì—”ë“œ ê¶Œí•œ ê´€ë¦¬

#### 2.5.1 ê¶Œí•œ í›…
```javascript
const usePermission = () => {
    const { user } = useAuth();
    
    const hasPermission = (action, resourceType, resourceId = null) => {
        if (!user) return false;
        
        const companyType = user.company.type;
        const userRole = user.role;
        
        // ë³¸ì‚¬ ê¶Œí•œ
        if (companyType === 'headquarters') {
            return true; // ë³¸ì‚¬ëŠ” ëª¨ë“  ê¶Œí•œ
        }
        
        // í˜‘ë ¥ì‚¬ ê¶Œí•œ
        if (companyType === 'agency') {
            if (action === 'read' && resourceType === 'company') {
                return true; // ìƒìœ„/í•˜ìœ„ ì—…ì²´ ì •ë³´ ì½ê¸° ê°€ëŠ¥
            }
            if (action === 'write' && resourceType === 'order') {
                return true; // í•˜ìœ„ íŒë§¤ì  ì£¼ë¬¸ ê´€ë¦¬ ê°€ëŠ¥
            }
            if (action === 'write' && resourceType === 'rebate') {
                return true; // í• ë‹¹ë°›ì€ ë¦¬ë² ì´íŠ¸ ê´€ë¦¬ ê°€ëŠ¥
            }
        }
        
        // íŒë§¤ì  ê¶Œí•œ
        if (companyType === 'retail') {
            if (action === 'read' && resourceType === 'company') {
                return true; // ìƒìœ„ ì—…ì²´ ì •ë³´ ì½ê¸° ê°€ëŠ¥
            }
            if (action === 'write' && resourceType === 'order') {
                return resourceId === user.company.id; // ë³¸ì¸ ì£¼ë¬¸ë§Œ
            }
        }
        
        return false;
    };
    
    return { hasPermission };
};
```

#### 2.5.2 ê¶Œí•œ ì»´í¬ë„ŒíŠ¸
```javascript
const PermissionGuard = ({ action, resourceType, resourceId, children, fallback = null }) => {
    const { hasPermission } = usePermission();
    
    if (!hasPermission(action, resourceType, resourceId)) {
        return fallback;
    }
    
    return children;
};

// ì‚¬ìš© ì˜ˆì‹œ
const OrderList = () => {
    return (
        <div>
            <h2>ì£¼ë¬¸ ëª©ë¡</h2>
            <PermissionGuard action="read" resourceType="order">
                <OrderTable />
                <PermissionGuard action="write" resourceType="order">
                    <CreateOrderButton />
                </PermissionGuard>
            </PermissionGuard>
        </div>
    );
};
```

### 2.6 ê³„ì¸µë³„ ë°ì´í„° ì ‘ê·¼

#### 2.6.1 ë³¸ì‚¬ ë°ì´í„° ì ‘ê·¼
```python
def get_hq_accessible_data(hq_company_id):
    """
    ë³¸ì‚¬ê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ëª¨ë“  ë°ì´í„°
    """
    # 1. ëª¨ë“  í•˜ìœ„ ì—…ì²´ ID ì¡°íšŒ
    all_subordinate_ids = Company.objects.filter(
        parent_company_id__in=Company.objects.filter(
            parent_company_id=hq_company_id
        ).values_list('id', flat=True)
    ).values_list('id', flat=True)
    
    # 2. ëª¨ë“  í•˜ìœ„ ì—…ì²´ì˜ ì£¼ë¬¸ ì¡°íšŒ
    orders = CustomerOrder.objects.filter(
        company_id__in=all_subordinate_ids
    )
    
    # 3. ëª¨ë“  í•˜ìœ„ ì—…ì²´ì˜ ë¦¬ë² ì´íŠ¸ ì •ë³´ ì¡°íšŒ
    rebates = RebateAllocation.objects.filter(
        to_company_id__in=all_subordinate_ids
    )
    
    return {
        'orders': orders,
        'rebates': rebates,
        'hierarchy': get_company_hierarchy_for_hq(hq_company_id)
    }
```

#### 2.6.2 í˜‘ë ¥ì‚¬ ë°ì´í„° ì ‘ê·¼
```python
def get_agency_accessible_data(agency_company_id):
    """
    í˜‘ë ¥ì‚¬ê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ë°ì´í„°
    """
    # 1. ìƒìœ„ ë³¸ì‚¬ ì •ë³´
    parent_hq = Company.objects.get(
        id=Company.objects.get(id=agency_company_id).parent_company_id
    )
    
    # 2. í•˜ìœ„ íŒë§¤ì ë“¤
    subordinate_retailers = Company.objects.filter(
        parent_company_id=agency_company_id
    )
    
    # 3. í•˜ìœ„ íŒë§¤ì ë“¤ì˜ ì£¼ë¬¸
    orders = CustomerOrder.objects.filter(
        company_id__in=subordinate_retailers.values_list('id', flat=True)
    )
    
    return {
        'parent_hq': parent_hq,
        'subordinate_retailers': subordinate_retailers,
        'orders': orders
    }
```

#### 2.6.3 íŒë§¤ì  ë°ì´í„° ì ‘ê·¼
```python
def get_retailer_accessible_data(retailer_company_id):
    """
    íŒë§¤ì ì´ ì ‘ê·¼ ê°€ëŠ¥í•œ ë°ì´í„°
    """
    # 1. ìƒìœ„ í˜‘ë ¥ì‚¬ ì •ë³´
    parent_agency = Company.objects.get(
        id=Company.objects.get(id=retailer_company_id).parent_company_id
    )
    
    # 2. ìƒìœ„ ë³¸ì‚¬ ì •ë³´
    parent_hq = Company.objects.get(
        id=parent_agency.parent_company_id
    )
    
    # 3. ë³¸ì¸ ì£¼ë¬¸ë“¤
    own_orders = CustomerOrder.objects.filter(
        company_id=retailer_company_id
    )
    
    return {
        'parent_agency': parent_agency,
        'parent_hq': parent_hq,
        'own_orders': own_orders
    }
```

### 2.7 ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ ìš”ì•½

#### 2.7.1 ê³„ì¸µë³„ ê¶Œí•œ ìš”ì•½
```
ë³¸ì‚¬ (HQ)
â”œâ”€â”€ ëª¨ë“  ì—…ì²´ ì •ë³´ ì¡°íšŒ/ìˆ˜ì •
â”œâ”€â”€ ëª¨ë“  ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ/ìˆ˜ì •
â”œâ”€â”€ ë¦¬ë² ì´íŠ¸ í• ë‹¹/ê´€ë¦¬
â”œâ”€â”€ ì •ì±… ìƒì„±/ìˆ˜ì •/ì‚­ì œ
â”œâ”€â”€ ìƒí’ˆ ê°€ê²© ê´€ë¦¬
â”œâ”€â”€ ì „ì²´ í†µê³„ ì¡°íšŒ
â”œâ”€â”€ ì •ì‚° ìŠ¹ì¸
â””â”€â”€ ì‹œìŠ¤í…œ ì„¤ì • ê´€ë¦¬

í˜‘ë ¥ì‚¬ (Agency)
â”œâ”€â”€ ë³¸ì‚¬ ì •ë³´ ì¡°íšŒ
â”œâ”€â”€ í•˜ìœ„ íŒë§¤ì  ì •ë³´ ì¡°íšŒ/ìˆ˜ì •
â”œâ”€â”€ ë³¸ì‚¬ ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
â”œâ”€â”€ í•˜ìœ„ íŒë§¤ì  ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
â”œâ”€â”€ í• ë‹¹ë°›ì€ ë¦¬ë² ì´íŠ¸ ê´€ë¦¬
â”œâ”€â”€ í•˜ìœ„ íŒë§¤ì ì— ë¦¬ë² ì´íŠ¸ ë¶„ë°°
â”œâ”€â”€ ìƒí’ˆ ê°€ê²© ì¡°íšŒ
â”œâ”€â”€ í•˜ìœ„ íŒë§¤ì  ì •ì‚° ìŠ¹ì¸
â””â”€â”€ ë³¸ì¸ í†µê³„ ì¡°íšŒ

íŒë§¤ì  (Retailer)
â”œâ”€â”€ ìƒìœ„ í˜‘ë ¥ì‚¬ ì •ë³´ ì¡°íšŒ
â”œâ”€â”€ ë³¸ì‚¬ ì •ë³´ ì¡°íšŒ
â”œâ”€â”€ ë³¸ì‚¬ ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
â”œâ”€â”€ ë³¸ì¸ ì£¼ë¬¸ ì •ë³´ ìƒì„±/ì¡°íšŒ/ìˆ˜ì •
â”œâ”€â”€ í• ë‹¹ë°›ì€ ë¦¬ë² ì´íŠ¸ ì‚¬ìš©
â”œâ”€â”€ ìƒí’ˆ ê°€ê²© ì¡°íšŒ
â”œâ”€â”€ ë³¸ì¸ ì •ì‚° í™•ì¸
â””â”€â”€ ë³¸ì¸ í†µê³„ ì¡°íšŒ
```

#### 2.7.2 ì—­í• ë³„ ê¶Œí•œ ìš”ì•½
```
ê´€ë¦¬ì (Admin)
â”œâ”€â”€ ì—…ì²´ ì •ë³´ ê´€ë¦¬
â”œâ”€â”€ ì‚¬ìš©ì ê´€ë¦¬
â”œâ”€â”€ ì •ì±… ê´€ë¦¬
â”œâ”€â”€ ì£¼ë¬¸ ê´€ë¦¬
â”œâ”€â”€ ë¦¬ë² ì´íŠ¸ ê´€ë¦¬
â”œâ”€â”€ ìƒí’ˆ ê°€ê²© ê´€ë¦¬
â”œâ”€â”€ ì •ì‚° ê´€ë¦¬
â””â”€â”€ í†µê³„ ì¡°íšŒ

ì§ì› (Staff)
â”œâ”€â”€ ì£¼ë¬¸ ìƒì„±
â”œâ”€â”€ ì£¼ë¬¸ ì¡°íšŒ
â”œâ”€â”€ ê³ ê° ì •ë³´ ê´€ë¦¬
â”œâ”€â”€ ìƒí’ˆ ê°€ê²© ì¡°íšŒ
â”œâ”€â”€ ë¦¬ë² ì´íŠ¸ ì”ì•¡ í™•ì¸
â””â”€â”€ ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
```

### 2.8 ê¶Œí•œ ê´€ë¦¬ ëª¨ë²” ì‚¬ë¡€

#### 2.8.1 ìµœì†Œ ê¶Œí•œ ì›ì¹™
```
âœ… í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬
âœ… ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)
âœ… ê³„ì¸µë³„ ë°ì´í„° ì ‘ê·¼ ì œì–´
âœ… ì‹¤ì‹œê°„ ê¶Œí•œ ê²€ì¦
```

#### 2.8.2 ë³´ì•ˆ ê°•í™”
```
âœ… JWT í† í° ê¸°ë°˜ ì¸ì¦
âœ… í† í° ê°±ì‹  ë©”ì»¤ë‹ˆì¦˜
âœ… ê¶Œí•œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´
âœ… ì„¸ì…˜ ê´€ë¦¬
âœ… HTTPS ê°•ì œ
âœ… SQL ì¸ì ì…˜ ë°©ì§€
âœ… XSS ë°©ì§€
âœ… CSRF ë³´í˜¸
```

ì´ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ëŠ” ì‹œìŠ¤í…œì˜ ë³´ì•ˆê³¼ ë°ì´í„° ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ëŠ” í•µì‹¬ ìš”ì†Œì…ë‹ˆë‹¤.
