# 주요 기능 및 핵심 로직 (Features and Core Logic)

`DN_solution` 프로젝트는 업체 및 사용자 관리, 주문 처리, 정책 관리 등 다양한 비즈니스 기능을 제공합니다. 이 문서는 각 기능의 핵심 로직과 구현 방식을 설명합니다.

## 1. 업체 및 사용자 관리 (Core: `companies` 앱)

### 1.1. 업체 계층 구조 및 유형 관리

*   **모델:** `Company` 모델 (`models.py`)
*   **유형:** `headquarters` (본사), `agency` (협력사), `retail` (판매점)
*   **계층 관계:** `parent_company` 필드를 통해 본사 -> 협력사 -> 판매점의 3단계 계층 구조를 형성합니다.
*   **핵심 로직 (`Company.clean()`):**
    *   본사는 상위 업체를 가질 수 없으며, 시스템에 하나만 존재해야 합니다.
    *   협력사는 반드시 본사를 상위 업체로 가져야 합니다.
    *   판매점은 반드시 협력사를 상위 업체로 가져야 합니다.
    *   동일한 업체명 중복을 방지합니다.

### 1.2. 업체 사용자 관리

*   **모델:** `CompanyUser` 모델 (`models.py`)
*   **역할:** `admin` (관리자), `staff` (직원)
*   **소속:** 모든 `CompanyUser`는 반드시 하나의 `Company`에 소속됩니다.
*   **핵심 로직 (`CompanyUser.save()`):** 사용자 생성/수정 시 로깅을 수행합니다.

### 1.3. 계층별 접근 권한 제어 (백엔드)

*   **구현 위치:** `companies/views.py`의 `CompanyViewSet.get_queryset()` 메서드.
*   **로직:** 로그인한 사용자의 `CompanyUser` 정보(소속 업체 유형)를 기반으로 조회 가능한 `Company` 및 `CompanyUser` 목록을 필터링합니다.
    *   **슈퍼유저/본사 사용자:** 모든 `Company` 및 `CompanyUser` 조회 가능.
    *   **협력사 사용자:** 자신이 소속된 협력사 및 그 하위 판매점, 그리고 이들에 속한 `CompanyUser`만 조회 가능.
    *   **판매점 사용자:** 자신이 소속된 판매점 및 그 소속 `CompanyUser`만 조회 가능.

### 1.4. 업체 생성 정책

*   **구현 위치:** `companies/views.py`의 `CompanyViewSet.create()` 메서드.
*   **현재 로직:**
    *   본사 계정은 협력사를 생성할 수 있습니다.
    *   본사 계정은 유효한 상위 협력사를 지정하는 경우 판매점도 생성할 수 있습니다.
    *   협력사 계정은 자신의 하위에 판매점을 생성할 수 있으며, 이때 상위 업체는 자동으로 해당 협력사로 지정됩니다.
*   **향후 강화 방안:** 본사가 판매점을 직접 생성하는 것을 명시적으로 금지하는 로직을 추가할 수 있습니다 (자세한 내용은 `Company_Creation_Policy.md` 참조).

### 1.5. 업체 상태 관리

*   **기능:** `Company`의 `status` 필드를 토글하여 운영 상태(운영 중/중단)를 변경합니다.
*   **구현 위치:** `Company.toggle_status()` 메서드 및 `CompanyViewSet.toggle_status` 액션.

## 2. 주문 관리 (`orders` 앱)

*   **기능:** 고객 주문 정보, 주문 메모, 송장 정보 등을 관리합니다.
*   **핵심 모델:** `Order`, `OrderMemo`, `Invoice`.
*   **주요 로직:** 주문 상태 변경, 메모 추가, 송장 생성 시 주문 상태 자동 업데이트 등.

## 3. 정책 관리 (`policies` 앱)

*   **기능:** 다양한 정책을 정의하고, 이를 특정 업체에 배정하며, 리베이트 등을 관리합니다.
*   **핵심 모델:** `Policy`, `PolicyAssignment`.
*   **주요 로직:** 정책 생성 시 HTML 콘텐츠 자동 생성, 정책 노출 상태 토글, 업체별 정책 배정 및 커스텀 리베이트 계산 등.

## 4. 공통 로직 및 고려사항

*   **UUID 기본 키:** 모든 주요 모델(`Company`, `CompanyUser`, `CompanyMessage`, `Order`, `Policy`)은 UUID를 기본 키로 사용하여 분산 환경에서의 고유성을 보장합니다.
*   **로깅:** `logging` 모듈을 사용하여 주요 비즈니스 이벤트(생성, 수정, 삭제, 상태 변경 등)를 상세하게 기록합니다. 이는 디버깅, 모니터링, 감사 추적에 활용됩니다.
*   **트랜잭션:** 데이터 일관성을 위해 여러 데이터베이스 작업이 필요한 경우 `django.db.transaction.atomic()`을 사용하여 원자성(Atomicity)을 보장합니다.
*   **DRF Serializer:** 데이터 유효성 검증 및 직렬화/역직렬화를 담당하며, API 요청/응답 데이터의 형식을 정의합니다.
*   **DRF ViewSet:** CRUD 작업을 위한 표준화된 API 엔드포인트를 제공하며, 필터링, 검색, 정렬 기능을 내장합니다.

이 문서는 `DN_solution` 프로젝트의 핵심 비즈니스 기능과 이를 구현하는 데 사용된 주요 로직 및 설계 원칙을 요약합니다.
